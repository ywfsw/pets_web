<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <title>å® ç‰©ç®¡å®¶</title>
</head>
<body>

<div id="app" class="container" @click.self="closeAllModals">

    <div>
        <header>
            <nav>
                <ul><li><strong>ğŸ¾ å® ç‰©ç®¡å®¶</strong></li></ul>
                <ul>
                    <li>
                        <a href="#" :class="{ 'secondary': currentPage !== 'pets' }" @click.prevent="currentPage = 'pets'">
                            å® ç‰©ç®¡ç†
                        </a>
                    </li>
                    <li>
                        <a href="#" :class="{ 'secondary': currentPage !== 'dictionaries' }" @click.prevent="showDictionaryPage">
                            å­—å…¸ç®¡ç†
                        </a>
                    </li>
                </ul>
            </nav>
        </header>

        <hr>

        <main v-if="currentPage === 'pets'">
            <article :aria-busy="loading.upcoming">
                <header><h5>ğŸ”” å³å°†åˆ°æœŸçš„äº‹ä»¶</h5></header>
                <ul v-if="upcomingEvents.length"><li v-for="event in upcomingEvents" :key="event.id"><strong>{{ event.nextDueDate }}</strong> - å® ç‰©ID {{ event.petId }} éœ€è¦: {{ event.notes || 'æ‰§è¡Œäº‹ä»¶' }}</li></ul>
                <p v-else><i>å¤ªå¥½äº†, 7å¤©å†…æ²¡æœ‰éœ€è¦æé†’çš„äº‹ä»¶ã€‚</i></p>
            </article>
            <br>
            <article :aria-busy="loading.list">
                <header><h3>å® ç‰©åˆ—è¡¨</h3><button @click="handleCreatePet">æ·»åŠ æ–°å® ç‰©</button></header>
                <table>
                    <thead><tr><th scope="col">ID</th><th scope="col">åå­—</th><th scope="col">æ“ä½œ</th></tr></thead>
                    <tbody>
                    <tr v-for="pet in petList" :key="pet.id">
                        <td>{{ pet.id }}</td>
                        <td><strong>{{ pet.name }}</strong></td>
                        <td>
                            <div class="grid" style="--pico-grid-spacing: 0.5rem;">
                                <button @click="handleShowDetail(pet.id)">æŸ¥çœ‹</button>
                                <button class="secondary" @click="handleEditPet(pet)">ç¼–è¾‘</button>
                                <button class="outline secondary" @click="handleDeletePet(pet.id, pet.name)">åˆ é™¤</button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </article>
        </main>

        <main v-if="currentPage === 'dictionaries'">

            <div class="grid">

                <article :aria-busy="loading.dictTypes">
                    <header>
                        <strong>å­—å…¸ç±»å‹</strong>
                        <button class="outline" @click="handleCreateDictType" style="padding: 0.25rem 0.5rem; margin-left: 1rem;">+</button>
                    </header>
                    <ul style="padding-left: 0; list-style: none;">
                        <li v-for="type in dictTypeTree" :key="type.dictCode">
                            <details :open="type.children.length > 0">
                                <summary>
                                    <a href="#"
                                       :style="{ color: type.dictCode === selectedDictCode ? 'var(--pico-primary)' : 'inherit' }"
                                       @click.prevent="selectDictType(type)">
                                        {{ type.dictName }} (<code>{{ type.dictCode }}</code>)
                                    </a>
                                    <a href="#" @click.prevent="handleEditDictType(type)" style="margin-left: 0.5rem; color: var(--pico-secondary);">[E]</a>
                                </summary>
                                <ul style="padding-left: 1rem; margin-top: 0.5rem;">
                                    <li v-for="child in type.children" :key="child.dictCode">
                                        <a href="#"
                                           :style="{ color: child.dictCode === selectedDictCode ? 'var(--pico-primary)' : 'inherit' }"
                                           @click.prevent="selectDictType(child)">
                                            {{ child.dictName }} (<code>{{ child.dictCode }}</code>)
                                        </a>
                                        <a href="#" @click.prevent="handleEditDictType(child)" style="margin-left: 0.5rem; color: var(--pico-secondary);">[E]</a>
                                    </li>
                                </ul>
                            </details>
                        </li>
                    </ul>
                </article>

                <article :aria-busy="loading.dictItems">
                    <header v-if="!selectedDictCode">
                        <strong>å­—å…¸é¡¹</strong><br>
                        <small>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå­—å…¸ç±»å‹</small>
                    </header>
                    <header v-else>
                        <strong>å­—å…¸é¡¹ (<code>{{ selectedDictCode }}</code>)</strong>
                        <button class="outline" @click="handleCreateDictItem" style="padding: 0.25rem 0.5rem; margin-left: 1rem;">+</button>
                    </header>
                    <table v-if="selectedDictCode">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>æ ‡ç­¾ (Label)</th>
                            <th>å€¼ (Value)</th>
                            <th>çˆ¶ID</th>
                            <th>æ“ä½œ</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="item in dictItemList" :key="item.id">
                            <td>{{ item.id }}</td>
                            <td><strong>{{ item.itemLabel }}</strong></td>
                            <td><code>{{ item.itemValue }}</code></td>
                            <td>{{ item.parentId || 'N/A' }}</td>
                            <td>
                                <button class="secondary" @click="handleEditDictItem(item)" style="padding: 0.25rem 0.5rem;">ç¼–è¾‘</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </article>

            </div> </main>

        <dialog :open="modals.detail.show" @click.self="closeAllModals">...</dialog>
        <dialog :open="modals.petForm.show" @click.self="closeAllModals">...</dialog>
        <dialog :open="modals.weightForm.show" @click.self="closeAllModals">...</dialog>
        <dialog :open="modals.healthEventForm.show" @click.self="closeAllModals">...</dialog>
        <dialog :open="modals.auth.show" @click.self="closeAllModals">...</dialog>
        <dialog :open="modals.dictForm.show" @click.self="closeAllModals">...</dialog>

        <dialog :open="modals.dictTypeForm.show" @click.self="closeAllModals">
            <article :aria-busy="loading.form">
                <header>
                    <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                    <strong>{{ modals.dictTypeForm.isEdit ? 'ç¼–è¾‘å­—å…¸ç±»å‹' : 'åˆ›å»ºæ–°å­—å…¸ç±»å‹' }}</strong>
                </header>

                <form @submit.prevent="handleSubmitDictTypeForm">
                    <label for="dtCode">å­—å…¸ç¼–ç  (Code)</label>
                    <input type="text" id="dtCode" v-model="modals.dictTypeForm.data.dictCode"
                           :readonly="modals.dictTypeForm.isEdit" required placeholder="ä¾‹å¦‚: PET_SPECIES">

                    <label for="dtName">å­—å…¸åç§° (Name)</label>
                    <input type="text" id="dtName" v-model="modals.dictTypeForm.data.dictName" required placeholder="ä¾‹å¦‚: å® ç‰©ç‰©ç§">

                    <label for="dtParentCode">çˆ¶çº§ç¼–ç  (å¯é€‰)</label>
                    <input type="text" id="dtParentCode" v-model="modals.dictTypeForm.data.parentCode" placeholder="ä¾‹å¦‚: PET_BASIC_INFO">

                    <label for="dtNotes">å¤‡æ³¨ (å¯é€‰)</label>
                    <textarea id="dtNotes" v-model="modals.dictTypeForm.data.notes"></textarea>

                    <footer>
                        <button type="button" class="secondary" @click="closeAllModals">å–æ¶ˆ</button>
                        <button type="submit" :aria-busy="loading.form">ä¿å­˜</button>
                        <button type="button" v-if="modals.dictTypeForm.isEdit"
                                @click="handleDeleteDictType"
                                class="outline contrast"
                                :aria-busy="loading.form">
                            åˆ é™¤
                        </button>
                    </footer>
                </form>
            </article>
        </dialog>

    </div> </div> <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp, ref, onMounted, computed, watch } = Vue;

    // --- é»˜è®¤è¡¨å•æ•°æ® ---
    const defaultPetForm = () => ({ name: '', birthday: '', speciesId: null, breedId: null });
    const defaultWeightForm = () => ({ weightKg: null, logDate: new Date().toISOString().split('T')[0], notes: '' });
    const defaultHealthForm = () => ({ eventTypeId: null, eventDate: new Date().toISOString().split('T')[0], nextDueDate: null, notes: '' });
    const defaultDictForm = () => ({ dictCode: '', itemValue: '', itemLabel: '', parentId: null, sortOrder: 0 });
    const defaultDictTypeForm = () => ({ dictCode: '', dictName: '', parentCode: null, notes: '' }); // (æ–°å¢)

    createApp({
        setup() {
            // --- API åœ°å€ ---
            const API_BASE_URL = 'https://pets-why3.onrender.com';

            // --- 1. å“åº”å¼çŠ¶æ€ (State) ---

            const auth = ref({ isAuthenticated: false, password: '', error: '', loading: false });
            const currentPage = ref('pets');

            const upcomingEvents = ref([]);
            const petList = ref([]);
            const pagination = ref({ current: 1, size: 10, total: 0 });

            // å­—å…¸ (V5 ä¸å˜)
            const dictionaries = ref({ species: [], breeds: [], healthEvents: [] });

            // (é‡æ„) å­—å…¸ç®¡ç†é¡µä¸“ç”¨
            const dictTypeList = ref([]); // (æ–°å¢) å·¦æ åˆ—è¡¨
            const selectedDictCode = ref(null); // (æ–°å¢) å·¦æ é€‰ä¸­çš„ code
            const dictItemList = ref([]); // (æ–°å¢) å³æ åˆ—è¡¨

            const loading = ref({
                list: false, detail: false, upcoming: false, form: false,
                dictTypes: false, // (æ–°å¢)
                dictItems: false  // (æ–°å¢)
            });

            const modals = ref({
                detail: { show: false, data: null, petId: null },
                petForm: { show: false, isEdit: false, data: defaultPetForm() },
                weightForm: { show: false, data: defaultWeightForm() },
                healthEventForm: { show: false, data: defaultHealthForm() },
                dictForm: { show: false, isEdit: false, data: defaultDictForm() }, // ç¼–è¾‘"å­—å…¸é¡¹"
                auth: { show: false },
                dictTypeForm: { show: false, isEdit: false, data: defaultDictTypeForm() } // (æ–°å¢) ç¼–è¾‘"å­—å…¸ç±»å‹"
            });

            // --- 2. è®¡ç®—å±æ€§ (Computed) ---

            // (V5 ä¸å˜) åŠ¨æ€è¿‡æ»¤å“ç§
            const filteredBreeds = computed(() => { /* (V5 ä»£ç ä¸å˜) */
                const speciesId = modals.value.petForm.data.speciesId;
                if (!speciesId) return [];
                return dictionaries.value.breeds.filter(b => b.parentId === speciesId);
            });

            // (æ–°å¢) å°†å­—å…¸ç±»å‹åˆ—è¡¨è½¬ä¸ºæ ‘çŠ¶ (ä»…ä¸€çº§)
            const dictTypeTree = computed(() => {
                const types = dictTypeList.value;
                const parents = types.filter(t => !t.parentCode);
                const children = types.filter(t => t.parentCode);

                return parents.map(p => ({
                    ...p,
                    children: children.filter(c => c.parentCode === p.dictCode)
                }));
            });

            // --- 3. æ–¹æ³• (Methods) ---

            // (V5 ä¸å˜) ç™»å½• & å¯¼èˆªå®ˆå«
            const login = () => { /* (V5 ä»£ç ä¸å˜) */
                auth.value.loading = true; auth.value.error = '';
                setTimeout(() => {
                    if (auth.value.password === '123456') {
                        auth.value.isAuthenticated = true; modals.value.auth.show = false; currentPage.value = 'dictionaries';
                    } else {
                        auth.value.error = 'å¯†ç é”™è¯¯';
                    }
                    auth.value.loading = false; auth.value.password = '';
                }, 300);
            };
            const showDictionaryPage = () => { /* (V5 ä»£ç ä¸å˜) */
                if (auth.value.isAuthenticated) {
                    currentPage.value = 'dictionaries';
                } else {
                    auth.value.error = ''; auth.value.password = ''; modals.value.auth.show = true;
                }
            };

            // --- æ•°æ®è·å– (å·²é‡æ„) ---
            const fetchPetList = () => { /* (V5 ä»£ç ä¸å˜) */ };
            const fetchUpcomingEvents = () => { /* (V5 ä»£ç ä¸å˜) */ };
            const fetchDictionaries = async () => { /* (V5 ä»£ç ä¸å˜) */ };
            const fetchPetDetail = (petId) => { /* (V5 ä»£ç ä¸å˜) */ };

            // (æ–°å¢) è·å–å­—å…¸ç±»å‹ (å·¦æ )
            const fetchDictTypeList = () => {
                loading.value.dictTypes = true;
                // ä½¿ç”¨ /dictTypes æ¥å£, å‡è®¾æ•°æ®é‡ä¸å¤§, ä¸åˆ†é¡µ
                axios.get(`${API_BASE_URL}/dictTypes`)
                    .then(res => {
                        dictTypeList.value = res.data;
                    })
                    .catch(err => alert('è·å–å­—å…¸ç±»å‹åˆ—è¡¨å¤±è´¥: ' + err.message))
                    .finally(() => loading.value.dictTypes = false);
            };

            // (æ–°å¢) è·å–å­—å…¸é¡¹ (å³æ )
            const fetchDictItemList = (dictCode) => {
                if (!dictCode) {
                    dictItemList.value = [];
                    return;
                }
                loading.value.dictItems = true;
                // ä½¿ç”¨ /dictItems/code/{dictCode} æ¥å£
                axios.get(`${API_BASE_URL}/dictItems/code/${dictCode}`)
                    .then(res => {
                        dictItemList.value = res.data;
                    })
                    .catch(err => alert(`è·å–å­—å…¸é¡¹ [${dictCode}] å¤±è´¥: ` + err.message))
                    .finally(() => loading.value.dictItems = false);
            };

            // (æ–°å¢) å·¦æ ç‚¹å‡»äº‹ä»¶
            const selectDictType = (type) => {
                selectedDictCode.value = type.dictCode;
                fetchDictItemList(type.dictCode);
            };


            // --- æ¨¡æ€æ¡†æ§åˆ¶ (å·²é‡æ„) ---
            const closeAllModals = () => {
                // (V5 ä»£ç  + æ–°å¢)
                modals.value.detail.show = false;
                modals.value.petForm.show = false;
                modals.value.weightForm.show = false;
                modals.value.healthEventForm.show = false;
                modals.value.dictForm.show = false;
                modals.value.auth.show = false;
                modals.value.dictTypeForm.show = false; // (æ–°å¢)
            };
            // (V5 æ–¹æ³•ä¸å˜)
            const handleShowDetail = (petId) => { /* (V5 ä»£ç ä¸å˜) */ };
            const handleCreatePet = () => { /* (V5 ä»£ç ä¸å˜) */ };
            const handleEditPet = (pet) => { /* (V5 ä»£ç ä¸å˜) */ };
            const handleShowWeightForm = () => { /* (V5 ä»£ç ä¸å˜) */ };
            const handleShowHealthEventForm = () => { /* (V5 ä»£ç ä¸å˜) */ };

            // (ä¿®æ”¹) åˆ›å»ºå­—å…¸é¡¹, è¦è‡ªåŠ¨å¸¦ä¸Š code
            const handleCreateDictItem = () => {
                if (!selectedDictCode.value) {
                    alert('è¯·å…ˆä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå­—å…¸ç±»å‹');
                    return;
                }
                closeAllModals();
                modals.value.dictForm.data = {
                    ...defaultDictForm(),
                    dictCode: selectedDictCode.value // è‡ªåŠ¨å¡«å…… code
                };
                modals.value.dictForm.isEdit = false;
                modals.value.dictForm.show = true;
            };

            // (ä¿®æ”¹) ç¼–è¾‘å­—å…¸é¡¹
            const handleEditDictItem = (item) => {
                closeAllModals();
                modals.value.dictForm.data = { ...item };
                modals.value.dictForm.isEdit = true;
                modals.value.dictForm.show = true;
            };

            // (æ–°å¢) å­—å…¸ç±»å‹è¡¨å•æ§åˆ¶
            const handleCreateDictType = () => {
                closeAllModals();
                modals.value.dictTypeForm.data = defaultDictTypeForm();
                modals.value.dictTypeForm.isEdit = false;
                modals.value.dictTypeForm.show = true;
            };
            const handleEditDictType = (type) => {
                closeAllModals();
                // (æ³¨æ„: ä» tree æ‹¿åˆ°çš„å¯èƒ½æ˜¯å­å¯¹è±¡, æˆ‘ä»¬è¦ä»åŸå§‹ list æ‹¿)
                const rawType = dictTypeList.value.find(t => t.dictCode === type.dictCode);
                modals.value.dictTypeForm.data = { ...rawType }; // å¤åˆ¶æ•°æ®
                modals.value.dictTypeForm.isEdit = true;
                modals.value.dictTypeForm.show = true;
            };

            // --- è¡¨å•æäº¤ (CRUD) ---
            // (V5 æ–¹æ³•ä¸å˜)
            const handleSubmitPetForm = () => { /* (V5 ä»£ç ä¸å˜) */ };
            const handleDeletePet = (petId, petName) => { /* (V5 ä»£ç ä¸å˜) */ };
            const handleSubmitWeightForm = () => { /* (V5 ä»£ç ä¸å˜) */ };
            const handleSubmitHealthEventForm = () => { /* (V5 ä»£ç ä¸å˜) */ };

            // (ä¿®æ”¹) å­—å…¸é¡¹æäº¤
            const handleSubmitDictForm = () => {
                loading.value.form = true;
                const { isEdit, data } = modals.value.dictForm;
                const payload = { ...data, parentId: data.parentId || null };
                const request = isEdit
                    ? axios.put(`${API_BASE_URL}/dictItems/${data.id}`, payload)
                    : axios.post(`${API_BASE_URL}/dictItems`, payload);

                request.then((res) => {
                    alert(res.data);
                    closeAllModals();
                    // (å…³é”®) åˆ·æ–°å½“å‰é€‰ä¸­çš„å­—å…¸é¡¹åˆ—è¡¨
                    fetchDictItemList(selectedDictCode.value);
                    // (å…³é”®) åˆ·æ–°ä¸šåŠ¡ä¸‹æ‹‰æ¡†
                    fetchDictionaries();
                })
                    .catch(err => alert('ä¿å­˜å­—å…¸é¡¹å¤±è´¥: ' + err.message))
                    .finally(() => loading.value.form = false);
            };

            // (ä¿®æ”¹) å­—å…¸é¡¹åˆ é™¤
            const handleDeleteDictItem = (item) => {
                if (!confirm(`ç¡®å®šè¦åˆ é™¤å­—å…¸é¡¹ [${item.itemLabel}] å—ï¼Ÿ`)) return;

                axios.delete(`${API_BASE_URL}/dictItems/${item.id}`)
                    .then((res) => {
                        alert(res.data);
                        fetchDictItemList(selectedDictCode.value);
                        fetchDictionaries();
                    })
                    .catch(err => alert('åˆ é™¤å­—å…¸é¡¹å¤±è´¥: ' + err.message));
            };

            // (æ–°å¢) å­—å…¸ç±»å‹æäº¤
            const handleSubmitDictTypeForm = () => {
                loading.value.form = true;
                const { isEdit, data } = modals.value.dictTypeForm;
                const payload = { ...data, parentCode: data.parentCode || null };

                const request = isEdit
                    ? axios.put(`${API_BASE_URL}/dictTypes/${data.dictCode}`, payload)
                    : axios.post(`${API_BASE_URL}/dictTypes`, payload);

                request.then((res) => {
                    alert(res.data);
                    closeAllModals();
                    fetchDictTypeList(); // åˆ·æ–°å·¦æ 
                })
                    .catch(err => alert('ä¿å­˜å­—å…¸ç±»å‹å¤±è´¥: ' + err.message))
                    .finally(() => loading.value.form = false);
            };

            // (æ–°å¢) å­—å…¸ç±»å‹åˆ é™¤
            const handleDeleteDictType = () => {
                const { data } = modals.value.dictTypeForm;
                if (!confirm(`(å±é™©!) ç¡®å®šè¦åˆ é™¤å­—å…¸ç±»å‹ [${data.dictName}] å—ï¼Ÿ\nå¦‚æœå®ƒä¸‹é¢è¿˜æœ‰å­—å…¸é¡¹, åˆ é™¤å¯èƒ½ä¼šå¤±è´¥ã€‚`)) return;

                axios.delete(`${API_BASE_URL}/dictTypes/${data.dictCode}`)
                    .then((res) => {
                        alert(res.data);
                        closeAllModals();
                        fetchDictTypeList(); // åˆ·æ–°å·¦æ 
                        // (å¦‚æœåˆ çš„æ˜¯å½“å‰é€‰ä¸­çš„)
                        if (selectedDictCode.value === data.dictCode) {
                            selectedDictCode.value = null;
                            dictItemList.value = [];
                        }
                    })
                    .catch(err => alert('åˆ é™¤å­—å…¸ç±»å‹å¤±è´¥: ' + err.message));
            };


            // --- 4. ç”Ÿå‘½å‘¨æœŸ (Lifecycle) ---

            // (V5 ä¸å˜) ç«‹å³åŠ è½½å® ç‰©é¡µæ‰€éœ€æ•°æ®
            onMounted(() => {
                loading.value.upcoming = true;
                loading.value.list = true;
                fetchDictionaries().then(() => {
                    fetchPetList();
                    fetchUpcomingEvents();
                });
            });

            // (ä¿®æ”¹) ç›‘å¬é¡µé¢åˆ‡æ¢
            watch(currentPage, (newPage) => {
                // ç¬¬ä¸€æ¬¡åˆ‡æ¢åˆ°å­—å…¸é¡µæ—¶, æ‡’åŠ è½½å·¦æ 
                if (newPage === 'dictionaries' && dictTypeList.value.length === 0) {
                    fetchDictTypeList();
                }
            });

            // --- 5. è¿”å› (Return) ---
            return {
                // è®¤è¯ & é¡µé¢
                auth, login, currentPage, showDictionaryPage,
                // å® ç‰©
                upcomingEvents, petList, loading, modals, filteredBreeds,
                // (æ–°å¢) å­—å…¸ç®¡ç†
                dictTypeList, dictTypeTree, selectedDictCode, dictItemList, selectDictType,
                // å® ç‰©æ–¹æ³•
                handleShowDetail, handleCreatePet, handleEditPet, handleDeletePet,
                handleSubmitPetForm, handleShowWeightForm, handleSubmitWeightForm,
                handleShowHealthEventForm, handleSubmitHealthEventForm, closeAllModals,
                // å­—å…¸é¡¹æ–¹æ³•
                handleCreateDictItem, handleEditDictItem, handleDeleteDictItem, handleSubmitDictForm,
                // (æ–°å¢) å­—å…¸ç±»å‹æ–¹æ³•
                handleCreateDictType, handleEditDictType, handleSubmitDictTypeForm, handleDeleteDictType
            };
        }
    }).mount('#app');
</script>

</body>
</html>