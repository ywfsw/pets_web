<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <title>å® ç‰©ç®¡å®¶</title>
</head>
<body>

<div id="app" class="container" @click.self="closeAllModals">

    <div>
        <header>
            <nav>
                <ul><li><strong>ğŸ¾ å® ç‰©ç®¡å®¶</strong></li></ul>
                <ul>
                    <li>
                        <a href="#" :class="{ 'secondary': currentPage !== 'pets' }" @click.prevent="currentPage = 'pets'">
                            å® ç‰©ç®¡ç†
                        </a>
                    </li>
                    <li>
                        <a href="#" :class="{ 'secondary': currentPage !== 'dictionaries' }" @click.prevent="showDictionaryPage">
                            å­—å…¸ç®¡ç†
                        </a>
                    </li>
                </ul>
            </nav>
        </header>

        <hr>

        <main v-if="currentPage === 'pets'">
            <article :aria-busy="loading.upcoming">
                <header><h5>ğŸ”” å³å°†åˆ°æœŸçš„äº‹ä»¶</h5></header>
                <ul v-if="upcomingEvents.length">
                    <li v-for="event in upcomingEvents" :key="event.id">
                        <strong>{{ event.nextDueDate }}</strong> - å® ç‰©ID {{ event.petId }} éœ€è¦: {{ event.notes || 'æ‰§è¡Œäº‹ä»¶' }}
                    </li>
                </ul>
                <p v-else><i>å¤ªå¥½äº†, 7å¤©å†…æ²¡æœ‰éœ€è¦æé†’çš„äº‹ä»¶ã€‚</i></p>
            </article>
            <br>
            <article :aria-busy="loading.list">
                <header>
                    <h3>æˆ‘çš„å® ç‰©</h3>
                    <button @click="handleCreatePet">æ·»åŠ æ–°å® ç‰©</button>
                </header>
                <table>
                    <thead>
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">åå­—</th>
                        <th scope="col">æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="pet in petList" :key="pet.id">
                        <td>{{ pet.id }}</td>
                        <td><strong>{{ pet.name }}</strong></td>
                        <td>
                            <div class="grid" style="--pico-grid-spacing: 0.5rem;">
                                <button @click="handleShowDetail(pet.id)">æŸ¥çœ‹</button>
                                <button class="secondary" @click="handleEditPet(pet)">ç¼–è¾‘</button>
                                <button class="outline secondary" @click="handleDeletePet(pet.id, pet.name)">åˆ é™¤</button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </article>
        </main>

        <main v-if="currentPage === 'dictionaries'">
            <div class="grid">
                <article :aria-busy="loading.dictTypes">
                    <header>
                        <strong>å­—å…¸ç±»å‹</strong>
                        <button class="outline" @click="handleCreateDictType" style="padding: 0.25rem 0.5rem; margin-left: 1rem;">+</button>
                    </header>
                    <ul style="padding-left: 0; list-style: none;">
                        <li v-for="type in dictTypeTree" :key="type.dictCode">
                            <details :open="type.children.length > 0">
                                <summary>
                                    <a href="#"
                                       :style="{ color: type.dictCode === selectedDictCode ? 'var(--pico-primary)' : 'inherit' }"
                                       @click.prevent="selectDictType(type)">
                                        {{ type.dictName }} (<code>{{ type.dictCode }}</code>)
                                    </a>
                                    <a href="#" @click.prevent="handleEditDictType(type)" style="margin-left: 0.5rem; color: var(--pico-secondary);">[E]</a>
                                </summary>
                                <ul style="padding-left: 1rem; margin-top: 0.5rem;">
                                    <li v-for="child in type.children" :key="child.dictCode">
                                        <a href="#"
                                           :style="{ color: child.dictCode === selectedDictCode ? 'var(--pico-primary)' : 'inherit' }"
                                           @click.prevent="selectDictType(child)">
                                            {{ child.dictName }} (<code>{{ child.dictCode }}</code>)
                                        </a>
                                        <a href="#" @click.prevent="handleEditDictType(child)" style="margin-left: 0.5rem; color: var(--pico-secondary);">[E]</a>
                                    </li>
                                </ul>
                            </details>
                        </li>
                    </ul>
                </article>

                <article :aria-busy="loading.dictItems">
                    <header v-if="!selectedDictCode">
                        <strong>å­—å…¸é¡¹</strong><br>
                        <small>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå­—å…¸ç±»å‹</small>
                    </header>
                    <header v-else>
                        <strong>å­—å…¸é¡¹ (<code>{{ selectedDictCode }}</code>)</strong>
                        <button class="outline" @click="handleCreateDictItem" style="padding: 0.25rem 0.5rem; margin-left: 1rem;">+</button>
                    </header>
                    <table v-if="selectedDictCode">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>æ ‡ç­¾ (Label)</th>
                            <th>å€¼ (Value)</th>
                            <th>çˆ¶ID</th>
                            <th>æ“ä½œ</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="item in dictItemList" :key="item.id">
                            <td>{{ item.id }}</td>
                            <td><strong>{{ item.itemLabel }}</strong></td>
                            <td><code>{{ item.itemValue }}</code></td>
                            <td>{{ item.parentId || 'N/A' }}</td>
                            <td>
                                <button class="secondary" @click="handleEditDictItem(item)" style="padding: 0.25rem 0.5rem;">ç¼–è¾‘</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </article>

            </div> </main>

        <dialog :open="modals.detail.show" @click.self="closeAllModals">
            <article :aria-busy="loading.detail">
                <header>
                    <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                    <strong>{{ modals.detail.data ? modals.detail.data.name : 'åŠ è½½ä¸­...' }}</strong>
                </header>
                <div v-if="modals.detail.data">
                    <ul>
                        <li><strong>ç‰©ç§:</strong> {{ modals.detail.data.speciesLabel }}</li>
                        <li><strong>å“ç§:</strong> {{ modals.detail.data.breedLabel }}</li>
                    </ul>
                    <hr>
                    <h4>è¿‘æœŸä½“é‡</h4>
                    <ul v-if="modals.detail.data.weightLogs && modals.detail.data.weightLogs.length">
                        <li v-for="log in modals.detail.data.weightLogs" :key="log.id">
                            {{ log.logDate }}: {{ log.weightKg }} kg
                        </li>
                    </ul>
                    <p v-else><i>æš‚æ— ä½“é‡è®°å½•</i></p>
                    <hr>
                    <h4>å¥åº·äº‹ä»¶</h4>
                    <ul v-if="modals.detail.data.healthEvents && modals.detail.data.healthEvents.length">
                        <li v-for="event in modals.detail.data.healthEvents" :key="event.id">
                            {{ event.eventDate }}: {{ event.notes || 'æ‰§è¡Œäº†äº‹ä»¶' }} (ä¸‹æ¬¡: {{ event.nextDueDate || 'N/A' }})
                        </li>
                    </ul>
                    <p v-else><i>æš‚æ— å¥åº·äº‹ä»¶</i></p>
                </div>
                <footer class="grid">
                    <button class="outline" @click="handleShowWeightForm">æ·»åŠ ä½“é‡</button>
                    <button class="outline" @click="handleShowHealthEventForm">æ·»åŠ äº‹ä»¶</button>
                    <button class="secondary" @click="closeAllModals">å…³é—­</button>
                </footer>
            </article>
        </dialog>

        <dialog :open="modals.petForm.show" @click.self="closeAllModals">
            <article :aria-busy="loading.form">
                <header>
                    <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                    <strong>{{ modals.petForm.isEdit ? 'ç¼–è¾‘å® ç‰©' : 'åˆ›å»ºæ–°å® ç‰©' }}</strong>
                </header>
                <form @submit.prevent="handleSubmitPetForm">
                    <label for="petName">åå­—</label>
                    <input type="text" id="petName" v-model="modals.petForm.data.name" required>
                    <label for="petBday">ç”Ÿæ—¥</label>
                    <input type="date" id="petBday" v-model="modals.petForm.data.birthday">
                    <label for="petSpecies">ç‰©ç§</label>
                    <select id="petSpecies" v-model="modals.petForm.data.speciesId" required>
                        <option disabled value="">è¯·é€‰æ‹©ç‰©ç§</option>
                        <option v-for="s in dictionaries.species" :value="s.id" :key="s.id">{{ s.itemLabel }}</option>
                    </select>
                    <label for="petBreed">å“ç§</label>
                    <select id="petBreed" v-model="modals.petForm.data.breedId">
                        <option value="">è¯·é€‰æ‹©å“ç§ (å¯é€‰)</option>
                        <option v-for="b in filteredBreeds" :value="b.id" :key="b.id">{{ b.itemLabel }}</option>
                    </select>
                    <footer>
                        <button type="button" class="secondary" @click="closeAllModals">å–æ¶ˆ</button>
                        <button type="submit" :aria-busy="loading.form">ä¿å­˜</button>
                    </footer>
                </form>
            </article>
        </dialog>

        <dialog :open="modals.weightForm.show" @click.self="closeAllModals">
            <article>
                <header>
                    <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                    <strong>æ·»åŠ ä½“é‡è®°å½•</strong>
                </header>
                <form @submit.prevent="handleSubmitWeightForm">
                    <label for="weightKg">ä½“é‡ (kg)</label>
                    <input type="number" step="0.01" id="weightKg" v-model="modals.weightForm.data.weightKg" required>
                    <label for="weightDate">è®°å½•æ—¥æœŸ</label>
                    <input type="date" id="weightDate" v-model="modals.weightForm.data.logDate" required>
                    <label for="weightNotes">å¤‡æ³¨</label>
                    <input type="text" id="weightNotes" v-model="modals.weightForm.data.notes" placeholder="å¯é€‰">
                    <footer>
                        <button type="button" class="secondary" @click="closeAllModals">å–æ¶ˆ</button>
                        <button type="submit" :aria-busy="loading.form">ä¿å­˜</button>
                    </footer>
                </form>
            </article>
        </dialog>

        <dialog :open="modals.healthEventForm.show" @click.self="closeAllModals">
            <article>
                <header>
                    <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                    <strong>æ·»åŠ å¥åº·äº‹ä»¶</strong>
                </header>
                <form @submit.prevent="handleSubmitHealthEventForm">
                    <label for="eventType">äº‹ä»¶ç±»å‹</label>
                    <select id="eventType" v-model="modals.healthEventForm.data.eventTypeId" required>
                        <option disabled value="">è¯·é€‰æ‹©äº‹ä»¶</option>
                        <option v-for="e in dictionaries.healthEvents" :value="e.id" :key="e.id">{{ e.itemLabel }}</option>
                    </select>
                    <label for="eventDate">äº‹ä»¶æ—¥æœŸ</label>
                    <input type="date" id="eventDate" v-model="modals.healthEventForm.data.eventDate" required>
                    <label for="eventNextDate">ä¸‹æ¬¡æ—¥æœŸ (å¯é€‰)</label>
                    <input type="date" id="eventNextDate" v-model="modals.healthEventForm.data.nextDueDate">
                    <label for="eventNotes">å¤‡æ³¨</label>
                    <input type="text" id="eventNotes" v-model="modals.healthEventForm.data.notes" placeholder="ä¾‹å¦‚: ç–«è‹—å“ç‰Œ, åŒ»é™¢">
                    <footer>
                        <button type="button" class="secondary" @click="closeAllModals">å–æ¶ˆ</button>
                        <button type="submit" :aria-busy="loading.form">ä¿å­˜</button>
                    </footer>
                </form>
            </article>
        </dialog>

        <dialog :open="modals.dictForm.show" @click.self="closeAllModals">
            <article :aria-busy="loading.form">
                <header>
                    <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                    <strong>{{ modals.dictForm.isEdit ? 'ç¼–è¾‘å­—å…¸é¡¹' : 'åˆ›å»ºæ–°å­—å…¸é¡¹' }}</strong>
                </header>
                <form @submit.prevent="handleSubmitDictForm">
                    <label for="dictCode">å­—å…¸ç¼–ç  (Code)</label>
                    <input type="text" id="dictCode" v-model="modals.dictForm.data.dictCode" required readonly>

                    <label for="dictLabel">æ ‡ç­¾ (Label)</label>
                    <input type="text" id="dictLabel" v-model="modals.dictForm.data.itemLabel" required placeholder="ä¾‹å¦‚: çŒ«">

                    <label for="dictValue">å€¼ (Value)</label>
                    <input type="text" id="dictValue" v-model="modals.dictForm.data.itemValue" required placeholder="ä¾‹å¦‚: cat">

                    <label for="dictParent">çˆ¶çº§ID (å¯é€‰)</label>
                    <input type="number" id="dictParent" v-model="modals.dictForm.data.parentId" placeholder="ç”¨äºå“ç§å…³è”ç‰©ç§">

                    <label for="dictSort">æ’åº</label>
                    <input type="number" id="dictSort" v-model="modals.dictForm.data.sortOrder">

                    <footer>
                        <button type="button" class="secondary" @click="closeAllModals">å–æ¶ˆ</button>
                        <button type="submit" :aria-busy="loading.form">ä¿å­˜</button>
                        <button type="button" v-if="modals.dictForm.isEdit"
                                @click="handleDeleteDictItem"
                                class="outline contrast"
                                :aria-busy="loading.form">
                            åˆ é™¤
                        </button>
                    </footer>
                </form>
            </article>
        </dialog>

        <dialog :open="modals.auth.show" @click.self="closeAllModals">
            <article style="max-width: 400px;">
                <header>
                    <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                    <strong>èº«ä»½è®¤è¯</strong>
                </header>
                <form @submit.prevent="login">
                    <label for="authPassword">è¯·è¾“å…¥å­—å…¸ç®¡ç†å¯†ç </label>
                    <input type="password" id="authPassword" v-model="auth.password" autofocus>
                    <button type="submit" :aria-busy="auth.loading">æäº¤</button>
                    <small v-if="auth.error" style="color: var(--pico-form-invalid-color);">{{ auth.error }}</small>
                </form>
            </article>
        </dialog>

        <dialog :open="modals.dictTypeForm.show" @click.self="closeAllModals">
            <article :aria-busy="loading.form">
                <header>
                    <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                    <strong>{{ modals.dictTypeForm.isEdit ? 'ç¼–è¾‘å­—å…¸ç±»å‹' : 'åˆ›å»ºæ–°å­—å…¸ç±»å‹' }}</strong>
                </header>
                <form @submit.prevent="handleSubmitDictTypeForm">
                    <label for="dtCode">å­—å…¸ç¼–ç  (Code)</label>
                    <input type="text" id="dtCode" v-model="modals.dictTypeForm.data.dictCode"
                           :readonly="modals.dictTypeForm.isEdit" required placeholder="ä¾‹å¦‚: PET_SPECIES">

                    <label for="dtName">å­—å…¸åç§° (Name)</label>
                    <input type="text" id="dtName" v-model="modals.dictTypeForm.data.dictName" required placeholder="ä¾‹å¦‚: å® ç‰©ç‰©ç§">

                    <label for="dtParentCode">çˆ¶çº§ç¼–ç  (å¯é€‰)</label>
                    <input type="text" id="dtParentCode" v-model="modals.dictTypeForm.data.parentCode" placeholder="ä¾‹å¦‚: PET_BASIC_INFO">

                    <label for="dtNotes">å¤‡æ³¨ (å¯é€‰)</label>
                    <textarea id="dtNotes" v-model="modals.dictTypeForm.data.notes"></textarea>

                    <footer>
                        <button type="button" class="secondary" @click="closeAllModals">å–æ¶ˆ</button>
                        <button type="submit" :aria-busy="loading.form">ä¿å­˜</button>
                        <button type="button" v-if="modals.dictTypeForm.isEdit"
                                @click="handleDeleteDictType"
                                class="outline contrast"
                                :aria-busy="loading.form">
                            åˆ é™¤
                        </button>
                    </footer>
                </form>
            </article>
        </dialog>

    </div> </div> <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp, ref, onMounted, computed, watch } = Vue;

    // --- é»˜è®¤è¡¨å•æ•°æ® ---
    const defaultPetForm = () => ({ name: '', birthday: '', speciesId: null, breedId: null });
    const defaultWeightForm = () => ({ weightKg: null, logDate: new Date().toISOString().split('T')[0], notes: '' });
    const defaultHealthForm = () => ({ eventTypeId: null, eventDate: new Date().toISOString().split('T')[0], nextDueDate: null, notes: '' });
    const defaultDictForm = () => ({ dictCode: '', itemValue: '', itemLabel: '', parentId: null, sortOrder: 0 });
    const defaultDictTypeForm = () => ({ dictCode: '', dictName: '', parentCode: null, notes: '' });

    createApp({
        setup() {
            // --- API åœ°å€ ---
            const API_BASE_URL = 'https://pets-why3.onrender.com';

            // --- 1. å“åº”å¼çŠ¶æ€ (State) ---

            const auth = ref({ isAuthenticated: false, password: '', error: '', loading: false });
            const currentPage = ref('pets');

            const upcomingEvents = ref([]);
            const petList = ref([]);
            const pagination = ref({ current: 1, size: 10, total: 0 });

            // å­—å…¸ (V5 ä¸å˜)
            const dictionaries = ref({ species: [], breeds: [], healthEvents: [] });

            // (é‡æ„) å­—å…¸ç®¡ç†é¡µä¸“ç”¨
            const dictTypeList = ref([]); // (æ–°å¢) å·¦æ åˆ—è¡¨
            const selectedDictCode = ref(null); // (æ–°å¢) å·¦æ é€‰ä¸­çš„ code
            const dictItemList = ref([]); // (æ–°å¢) å³æ åˆ—è¡¨

            const loading = ref({
                list: false, detail: false, upcoming: false, form: false,
                dictTypes: false, // (æ–°å¢)
                dictItems: false  // (æ–°å¢)
            });

            const modals = ref({
                detail: { show: false, data: null, petId: null },
                petForm: { show: false, isEdit: false, data: defaultPetForm() },
                weightForm: { show: false, data: defaultWeightForm() },
                healthEventForm: { show: false, data: defaultHealthForm() },
                dictForm: { show: false, isEdit: false, data: defaultDictForm() }, // ç¼–è¾‘"å­—å…¸é¡¹"
                auth: { show: false },
                dictTypeForm: { show: false, isEdit: false, data: defaultDictTypeForm() } // (æ–°å¢) ç¼–è¾‘"å­—å…¸ç±»å‹"
            });

            // --- 2. è®¡ç®—å±æ€§ (Computed) ---

            const filteredBreeds = computed(() => {
                const speciesId = modals.value.petForm.data.speciesId;
                if (!speciesId) return [];
                return dictionaries.value.breeds.filter(b => b.parentId === speciesId);
            });

            const dictTypeTree = computed(() => {
                const types = dictTypeList.value;
                const parents = types.filter(t => !t.parentCode);
                const children = types.filter(t => t.parentCode);

                return parents.map(p => ({
                    ...p,
                    children: children.filter(c => c.parentCode === p.dictCode)
                }));
            });

            // --- 3. æ–¹æ³• (Methods) ---

            const login = () => {
                auth.value.loading = true; auth.value.error = '';
                setTimeout(() => {
                    if (auth.value.password === '125456') { // â— ä¿®æ­£: ä½ çš„å¯†ç æ˜¯ 123456
                        auth.value.isAuthenticated = true; modals.value.auth.show = false; currentPage.value = 'dictionaries';
                    } else {
                        auth.value.error = 'å¯†ç é”™è¯¯';
                    }
                    auth.value.loading = false; auth.value.password = '';
                }, 300);
            };

            const showDictionaryPage = () => {
                if (auth.value.isAuthenticated) {
                    currentPage.value = 'dictionaries';
                } else {
                    auth.value.error = ''; auth.value.password = ''; modals.value.auth.show = true;
                }
            };

            // --- æ•°æ®è·å– ---
            const fetchPetList = () => {
                loading.value.list = true;
                axios.get(`${API_BASE_URL}/pets/page`, { params: { pageNum: pagination.value.current, pageSize: pagination.value.size } })
                    .then(res => { petList.value = res.data.records; pagination.value.total = res.data.total; })
                    .catch(err => alert('è·å–å® ç‰©åˆ—è¡¨å¤±è´¥: ' + err.message))
                    .finally(() => loading.value.list = false);
            };
            const fetchUpcomingEvents = () => {
                loading.value.upcoming = true;
                axios.get(`${API_BASE_URL}/health-events/upcoming`)
                    .then(res => upcomingEvents.value = res.data)
                    .catch(err => console.error('è·å–æé†’å¤±è´¥:', err))
                    .finally(() => loading.value.upcoming = false);
            };
            const fetchDictionaries = async () => {
                try {
                    const [speciesRes, breedsRes, eventsRes] = await Promise.all([
                        axios.get(`${API_BASE_URL}/dictItems/code/PET_SPECIES`),
                        axios.get(`${API_BASE_URL}/dictItems/code/PET_BREED`),
                        axios.get(`${API_BASE_URL}/dictItems/code/HEALTH_EVENT_TYPE`)
                    ]);
                    dictionaries.value.species = speciesRes.data;
                    dictionaries.value.breeds = breedsRes.data;
                    dictionaries.value.healthEvents = eventsRes.data;
                } catch (err) {
                    alert('åŠ è½½åŸºç¡€æ•°æ®å¤±è´¥ï¼è¯·åˆ·æ–°é¡µé¢ã€‚' + err.message);
                }
            };
            const fetchPetDetail = (petId) => {
                loading.value.detail = true;
                axios.get(`${API_BASE_URL}/pets/detail/${petId}`)
                    .then(res => modals.value.detail.data = res.data)
                    .catch(err => { alert('è·å–å® ç‰©è¯¦æƒ…å¤±è´¥: ' + err.message); modals.value.detail.show = false; })
                    .finally(() => loading.value.detail = false);
            };

            const fetchDictTypeList = () => {
                loading.value.dictTypes = true;
                axios.get(`${API_BASE_URL}/dictTypes`)
                    .then(res => {
                        dictTypeList.value = res.data;
                    })
                    .catch(err => alert('è·å–å­—å…¸ç±»å‹åˆ—è¡¨å¤±è´¥: ' + err.message))
                    .finally(() => loading.value.dictTypes = false);
            };

            const fetchDictItemList = (dictCode) => {
                if (!dictCode) {
                    dictItemList.value = [];
                    return;
                }
                loading.value.dictItems = true;
                axios.get(`${API_BASE_URL}/dictItems/code/${dictCode}`)
                    .then(res => {
                        dictItemList.value = res.data;
                    })
                    .catch(err => alert(`è·å–å­—å…¸é¡¹ [${dictCode}] å¤±è´¥: ` + err.message))
                    .finally(() => loading.value.dictItems = false);
            };

            const selectDictType = (type) => {
                selectedDictCode.value = type.dictCode;
                fetchDictItemList(type.dictCode);
            };

            // --- æ¨¡æ€æ¡†æ§åˆ¶ ---
            const closeAllModals = () => {
                modals.value.detail.show = false;
                modals.value.petForm.show = false;
                modals.value.weightForm.show = false;
                modals.value.healthEventForm.show = false;
                modals.value.dictForm.show = false;
                modals.value.auth.show = false;
                modals.value.dictTypeForm.show = false;
            };
            const handleShowDetail = (petId) => { closeAllModals(); modals.value.detail.petId = petId; modals.value.detail.data = null; modals.value.detail.show = true; fetchPetDetail(petId); };
            const handleCreatePet = () => { closeAllModals(); modals.value.petForm.data = defaultPetForm(); modals.value.petForm.isEdit = false; modals.value.petForm.show = true; };
            const handleEditPet = (pet) => { closeAllModals(); modals.value.petForm.data = { id: pet.id, name: pet.name, birthday: pet.birthday, speciesId: pet.speciesId, breedId: pet.breedId }; modals.value.petForm.isEdit = true; modals.value.petForm.show = true; };
            const handleShowWeightForm = () => { modals.value.weightForm.data = defaultWeightForm(); modals.value.weightForm.show = true; };
            const handleShowHealthEventForm = () => { modals.value.healthEventForm.data = defaultHealthForm(); modals.value.healthEventForm.show = true; };

            const handleCreateDictItem = () => {
                if (!selectedDictCode.value) {
                    alert('è¯·å…ˆä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå­—å…¸ç±»å‹');
                    return;
                }
                closeAllModals();
                modals.value.dictForm.data = {
                    ...defaultDictForm(),
                    dictCode: selectedDictCode.value
                };
                modals.value.dictForm.isEdit = false;
                modals.value.dictForm.show = true;
            };

            const handleEditDictItem = (item) => {
                closeAllModals();
                modals.value.dictForm.data = { ...item };
                modals.value.dictForm.isEdit = true;
                modals.value.dictForm.show = true;
            };

            const handleCreateDictType = () => {
                closeAllModals();
                modals.value.dictTypeForm.data = defaultDictTypeForm();
                modals.value.dictTypeForm.isEdit = false;
                modals.value.dictTypeForm.show = true;
            };
            const handleEditDictType = (type) => {
                closeAllModals();
                const rawType = dictTypeList.value.find(t => t.dictCode === type.dictCode);
                modals.value.dictTypeForm.data = { ...rawType };
                modals.value.dictTypeForm.isEdit = true;
                modals.value.dictTypeForm.show = true;
            };

            // --- è¡¨å•æäº¤ (CRUD) ---
            const handleSubmitPetForm = () => {
                loading.value.form = true;
                const { isEdit, data } = modals.value.petForm;
                const request = isEdit ? axios.put(`${API_BASE_URL}/pets/${data.id}`, data) : axios.post(`${API_BASE_URL}/pets`, data);
                request.then(() => {
                    closeAllModals();
                    fetchPetList();
                }).catch(err => alert('ä¿å­˜å® ç‰©å¤±è´¥: ' + err.message)).finally(() => loading.value.form = false);
            };

            const handleDeletePet = (petId, petName) => {
                if (!confirm(`ç¡®å®šè¦åˆ é™¤ [${petName}] å—ï¼Ÿ`)) return;
                axios.delete(`${API_BASE_URL}/pets/${petId}`)
                    .then(() => {
                        fetchPetList();
                    }).catch(err => alert('åˆ é™¤å® ç‰©å¤±è´¥: ' + err.message));
            };

            const handleSubmitWeightForm = () => {
                loading.value.form = true;
                const payload = { ...modals.value.weightForm.data, petId: modals.value.detail.petId };
                axios.post(`${API_BASE_URL}/weight-logs`, payload)
                    .then(() => {
                        modals.value.weightForm.show = false;
                        fetchPetDetail(modals.value.detail.petId);
                    }).catch(err => alert('ä¿å­˜ä½“é‡å¤±è´¥: ' + err.message)).finally(() => loading.value.form = false);
            };

            const handleSubmitHealthEventForm = () => {
                loading.value.form = true;
                const payload = { ...modals.value.healthEventForm.data, petId: modals.value.detail.petId };
                axios.post(`${API_BASE_URL}/health-events`, payload)
                    .then(() => {
                        modals.value.healthEventForm.show = false;
                        fetchPetDetail(modals.value.detail.petId);
                        fetchUpcomingEvents();
                    }).catch(err => alert('ä¿å­˜äº‹ä»¶å¤±è´¥: ' + err.message)).finally(() => loading.value.form = false);
            };

            const handleSubmitDictForm = () => {
                loading.value.form = true;
                const { isEdit, data } = modals.value.dictForm;
                const payload = { ...data, parentId: data.parentId || null };
                const request = isEdit
                    ? axios.put(`${API_BASE_URL}/dictItems/${data.id}`, payload)
                    : axios.post(`${API_BASE_URL}/dictItems`, payload);

                request.then((res) => {
                    alert(res.data);
                    closeAllModals();
                    fetchDictItemList(selectedDictCode.value);
                    fetchDictionaries();
                })
                    .catch(err => alert('ä¿å­˜å­—å…¸é¡¹å¤±è´¥: ' + err.message))
                    .finally(() => loading.value.form = false);
            };

            const handleDeleteDictItem = () => {
                const { data } = modals.value.dictForm;
                if (!confirm(`ç¡®å®šè¦åˆ é™¤å­—å…¸é¡¹ [${data.itemLabel}] å—ï¼Ÿ`)) return;

                axios.delete(`${API_BASE_URL}/dictItems/${data.id}`)
                    .then((res) => {
                        alert(res.data);
                        closeAllModals();
                        fetchDictItemList(selectedDictCode.value);
                        fetchDictionaries();
                    })
                    .catch(err => alert('åˆ é™¤å­—å…¸é¡¹å¤±è´¥: ' + err.message));
            };

            const handleSubmitDictTypeForm = () => {
                loading.value.form = true;
                const { isEdit, data } = modals.value.dictTypeForm;
                const payload = { ...data, parentCode: data.parentCode || null };

                const request = isEdit
                    ? axios.put(`${API_BASE_URL}/dictTypes/${data.dictCode}`, payload)
                    : axios.post(`${API_BASE_URL}/dictTypes`, payload);

                request.then((res) => {
                    alert(res.data);
                    closeAllModals();
                    fetchDictTypeList();
                })
                    .catch(err => alert('ä¿å­˜å­—å…¸ç±»å‹å¤±è´¥: ' + err.message))
                    .finally(() => loading.value.form = false);
            };

            const handleDeleteDictType = () => {
                const { data } = modals.value.dictTypeForm;
                if (!confirm(`(å±é™©!) ç¡®å®šè¦åˆ é™¤å­—å…¸ç±»å‹ [${data.dictName}] å—ï¼Ÿ\nå¦‚æœå®ƒä¸‹é¢è¿˜æœ‰å­—å…¸é¡¹, åˆ é™¤å¯èƒ½ä¼šå¤±è´¥ã€‚`)) return;

                axios.delete(`${API_BASE_URL}/dictTypes/${data.dictCode}`)
                    .then((res) => {
                        alert(res.data);
                        closeAllModals();
                        fetchDictTypeList();
                        if (selectedDictCode.value === data.dictCode) {
                            selectedDictCode.value = null;
                            dictItemList.value = [];
                        }
                    })
                    .catch(err => alert('åˆ é™¤å­—å…¸ç±»å‹å¤±è´¥: ' + err.message));
            };

            // --- 4. ç”Ÿå‘½å‘¨æœŸ (Lifecycle) ---

            onMounted(() => {
                loading.value.upcoming = true;
                loading.value.list = true;
                fetchDictionaries().then(() => {
                    fetchPetList();
                    fetchUpcomingEvents();
                });
            });

            watch(currentPage, (newPage) => {
                if (newPage === 'dictionaries' && dictTypeList.value.length === 0) {
                    fetchDictTypeList();
                }
            });

            // --- 5. è¿”å› (Return) ---
            return {
                // è®¤è¯ & é¡µé¢
                auth, login, currentPage, showDictionaryPage,
                // å® ç‰©
                upcomingEvents, petList, loading, modals, filteredBreeds,
                // å­—å…¸ç®¡ç†
                dictTypeList, dictTypeTree, selectedDictCode, dictItemList, selectDictType,
                // å® ç‰©æ–¹æ³•
                handleShowDetail, handleCreatePet, handleEditPet, handleDeletePet,
                handleSubmitPetForm, handleShowWeightForm, handleSubmitWeightForm,
                handleShowHealthEventForm, handleSubmitHealthEventForm, closeAllModals,
                // å­—å…¸é¡¹æ–¹æ³•
                handleCreateDictItem, handleEditDictItem, handleDeleteDictItem, handleSubmitDictForm,
                // å­—å…¸ç±»å‹æ–¹æ³•
                handleCreateDictType, handleEditDictType, handleSubmitDictTypeForm, handleDeleteDictType
            };
        }
    }).mount('#app');
</script>

</body>
</html>