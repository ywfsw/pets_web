<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  
  <title>å® ç‰©ç®¡å®¶</title>
</head>
<body>

  <div id="app" class="container">

    <header>
      <nav>
        <ul><li><strong>ğŸ¾ å® ç‰©ç®¡å®¶</strong></li></ul>
        <ul><li><a href="#">é¦–é¡µ</a></li></ul>
      </nav>
    </header>

    <hr>

    <main>
      <article :aria-busy="loading.list">
        <header>
          <h3>æˆ‘çš„å® ç‰©åˆ—è¡¨</h3>
          </header>
        
        <table>
          <thead>
            <tr>
              <th scope="col">ID</th>
              <th scope="col">åå­—</th>
              <th scope="col">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="pet in petList" :key="pet.id">
              <td>{{ pet.id }}</td>
              <td><strong>{{ pet.name }}</strong></td>
              <td>
                <button @click="showPetDetail(pet.id)">
                  æŸ¥çœ‹è¯¦æƒ…
                </button>
              </td>
            </tr>
          </tbody>
        </table>
        
        </article>

      <dialog :open="modal.show">
        <article :aria-busy="loading.detail">
          <header>
            <a href="#" 
               aria-label="Close" 
               class="close"
               @click.prevent="closeModal">
            </a>
            <strong>{{ modal.data ? modal.data.name : 'åŠ è½½ä¸­...' }}</strong>
          </header>
          
          <div v-if="modal.data">
            <ul>
              <li><strong>ç‰©ç§:</strong> {{ modal.data.speciesLabel }}</li>
              <li><strong>å“ç§:</strong> {{ modal.data.breedLabel }}</li>
            </ul>

            <hr>
            
            <h4>è¿‘æœŸä½“é‡</h4>
            <ul v-if="modal.data.weightLogs && modal.data.weightLogs.length">
              <li v-for="log in modal.data.weightLogs" :key="log.id">
                {{ log.logDate }}: {{ log.weightKg }} kg
              </li>
            </ul>
            <p v-else><i>æš‚æ— ä½“é‡è®°å½•</i></p>

            <h4>å¥åº·äº‹ä»¶</h4>
            <ul v-if="modal.data.healthEvents && modal.data.healthEvents.length">
              <li v-for="event in modal.data.healthEvents" :key="event.id">
                {{ event.eventDate }}: {{ event.notes || 'æ‰§è¡Œäº†äº‹ä»¶' }}
                (ä¸‹æ¬¡: {{ event.nextDueDate || 'N/A' }})
              </li>
            </ul>
            <p v-else><i>æš‚æ— å¥åº·äº‹ä»¶</i></p>

          </div>
          
          <footer>
            <button @click="closeModal">å…³é—­</button>
          </footer>
        </article>
      </dialog>

    </main>

  </div> <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
      setup() {
        // --- ä½ çš„åç«¯ API åœ°å€ ---
        // â—â—â— ç¡®ä¿ä½ å·²ç»åœ¨ Spring Boot ä¸Šè®¾ç½®äº† @CrossOrigin("*") â—â—â—
        const API_BASE_URL = 'https://pets-why3.onrender.com';

        // --- 1. å“åº”å¼çŠ¶æ€ (State) ---
        
        // å® ç‰©åˆ—è¡¨
        const petList = ref([]); 
        const pagination = ref({ current: 1, size: 10, total: 0 });
        
        // æ¨¡æ€æ¡† (Modal)
        const modal = ref({
          show: false,
          data: null // å­˜å‚¨ /pets/detail/{id} è¿”å›çš„æ•°æ®
        });

        // åŠ è½½çŠ¶æ€
        const loading = ref({
          list: false,
          detail: false
        });

        // --- 2. æ–¹æ³• (Methods) ---

        // (æ–¹æ³• A) è·å–å® ç‰©åˆ—è¡¨
        const fetchPetList = () => {
          loading.value.list = true;
          axios.get(`${API_BASE_URL}/pets/page`, {
            params: {
              pageNum: pagination.value.current,
              pageSize: pagination.value.size
            }
          })
          .then(response => {
            petList.value = response.data.records;
            pagination.value.total = response.data.total;
          })
          .catch(error => {
            console.error('è·å–å® ç‰©åˆ—è¡¨å¤±è´¥:', error);
            alert('è·å–å® ç‰©åˆ—è¡¨å¤±è´¥');
          })
          .finally(() => {
            loading.value.list = false;
          });
        };

        // (æ–¹æ³• B) è·å–å® ç‰©è¯¦æƒ…, å¹¶æ‰“å¼€æ¨¡æ€æ¡†
        const showPetDetail = (petId) => {
          modal.value.show = true;    // ç«‹å³æ‰“å¼€æ¨¡æ€æ¡†
          loading.value.detail = true; // æ˜¾ç¤ºåŠ è½½ä¸­
          modal.value.data = null;     // æ¸…ç©ºæ—§æ•°æ®

          axios.get(`${API_BASE_URL}/pets/detail/${petId}`)
            .then(response => {
              modal.value.data = response.data;
            })
            .catch(error => {
              console.error('è·å–å® ç‰©è¯¦æƒ…å¤±è´¥:', error);
              alert('è·å–å® ç‰©è¯¦æƒ…å¤±è´¥');
              modal.value.show = false; // åŠ è½½å¤±è´¥, å…³é—­æ¨¡æ€æ¡†
            })
            .finally(() => {
              loading.value.detail = false;
            });
        };

        // (æ–¹æ³• C) å…³é—­æ¨¡æ€æ¡†
        const closeModal = () => {
          modal.value.show = false;
        };

        // --- 3. ç”Ÿå‘½å‘¨æœŸ (Lifecycle) ---
        
        // å½“é¡µé¢ (Vue å®ä¾‹) åŠ è½½å®Œæˆå, è‡ªåŠ¨è¿è¡Œ
        onMounted(() => {
          fetchPetList();
        });

        // --- 4. è¿”å› (Return) ---
        // å¿…é¡»è¿”å›, è¿™æ · HTML æ‰èƒ½ä½¿ç”¨å®ƒä»¬
        return {
          petList,
          loading,
          modal,
          showPetDetail,
          closeModal
        };
      }
    }).mount('#app'); // æŒ‚è½½åˆ° <div id="app">
  </script>

</body>
</html>
