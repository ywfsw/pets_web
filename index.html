<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">

    <title>å® ç‰©ç®¡å®¶</title>
</head>
<body>

<div id="app" class="container" @click.self="closeAllModals">

    <header>
        <nav>
            <ul><li><strong>ğŸ¾ å® ç‰©ç®¡å®¶</strong></li></ul>
            <ul><li><a href="#">é¦–é¡µ</a></li></ul>
        </nav>
    </header>

    <hr>

    <main>
        <article :aria-busy="loading.upcoming">
            <header><h5>ğŸ”” å³å°†åˆ°æœŸçš„äº‹ä»¶</h5></header>
            <ul v-if="upcomingEvents.length">
                <li v-for="event in upcomingEvents" :key="event.id">
                    <strong>{{ event.nextDueDate }}</strong> -
                    å® ç‰©ID {{ event.petId }} éœ€è¦: {{ event.notes || 'æ‰§è¡Œäº‹ä»¶' }}
                </li>
            </ul>
            <p v-else><i>å¤ªå¥½äº†, 7å¤©å†…æ²¡æœ‰éœ€è¦æé†’çš„äº‹ä»¶ã€‚</i></p>
        </article>

        <br>

        <article :aria-busy="loading.list">
            <header>
                <h3>æˆ‘çš„å® ç‰©</h3>
                <button @click="handleCreatePet">æ·»åŠ æ–°å® ç‰©</button>
            </header>

            <table>
                <thead>
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">åå­—</th>
                    <th scope="col">æ“ä½œ</th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="pet in petList" :key="pet.id">
                    <td>{{ pet.id }}</td>
                    <td><strong>{{ pet.name }}</strong></td>
                    <td>
                        <div class="grid" style="--pico-grid-spacing: 0.5rem;">
                            <button @click="handleShowDetail(pet.id)">æŸ¥çœ‹</button>
                            <button class="secondary" @click="handleEditPet(pet)">ç¼–è¾‘</button>
                            <button class="outline secondary" @click="handleDeletePet(pet.id, pet.name)">åˆ é™¤</button>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>

        </article>

        <dialog :open="modals.detail.show" @click.self="closeAllModals">
            <article :aria-busy="loading.detail">
                <header>
                    <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                    <strong>{{ modals.detail.data ? modals.detail.data.name : 'åŠ è½½ä¸­...' }}</strong>
                </header>

                <div v-if="modals.detail.data">
                    <ul>
                        <li><strong>ç‰©ç§:</strong> {{ modals.detail.data.speciesLabel }}</li>
                        <li><strong>å“ç§:</strong> {{ modals.detail.data.breedLabel }}</li>
                    </ul>
                    <hr>
                    <h4>è¿‘æœŸä½“é‡</h4>
                    <ul v-if="modals.detail.data.weightLogs && modals.detail.data.weightLogs.length">
                        <li v-for="log in modals.detail.data.weightLogs" :key="log.id">
                            {{ log.logDate }}: {{ log.weightKg }} kg
                        </li>
                    </ul>
                    <p v-else><i>æš‚æ— ä½“é‡è®°å½•</i></p>
                    <hr>
                    <h4>å¥åº·äº‹ä»¶</h4>
                    <ul v-if="modals.detail.data.healthEvents && modals.detail.data.healthEvents.length">
                        <li v-for="event in modals.detail.data.healthEvents" :key="event.id">
                            {{ event.eventDate }}: {{ event.notes || 'æ‰§è¡Œäº†äº‹ä»¶' }}
                            (ä¸‹æ¬¡: {{ event.nextDueDate || 'N/A' }})
                        </li>
                    </ul>
                    <p v-else><i>æš‚æ— å¥åº·äº‹ä»¶</i></p>
                </div>

                <footer class="grid">
                    <button class="outline" @click="handleShowWeightForm">æ·»åŠ ä½“é‡</button>
                    <button class="outline" @click="handleShowHealthEventForm">æ·»åŠ äº‹ä»¶</button>
                    <button class="secondary" @click="closeAllModals">å…³é—­</button>
                </footer>
            </article>
        </dialog>

        <dialog :open="modals.petForm.show" @click.self="closeAllModals">
            <article :aria-busy="loading.form">
                <header>
                    <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                    <strong>{{ modals.petForm.isEdit ? 'ç¼–è¾‘å® ç‰©' : 'åˆ›å»ºæ–°å® ç‰©' }}</strong>
                </header>

                <form @submit.prevent="handleSubmitPetForm">
                    <label for="petName">åå­—</label>
                    <input type="text" id="petName" v-model="modals.petForm.data.name" required>

                    <label for="petBday">ç”Ÿæ—¥</label>
                    <input type="date" id="petBday" v-model="modals.petForm.data.birthday">

                    <label for="petSpecies">ç‰©ç§</label>
                    <select id="petSpecies" v-model="modals.petForm.data.speciesId" required>
                        <option disabled value="">è¯·é€‰æ‹©ç‰©ç§</option>
                        <option v-for="s in dictionaries.species" :value="s.id" :key="s.id">
                            {{ s.itemLabel }}
                        </option>
                    </select>

                    <label for="petBreed">å“ç§</label>
                    <select id="petBreed" v-model="modals.petForm.data.breedId">
                        <option value="">è¯·é€‰æ‹©å“ç§ (å¯é€‰)</option>
                        <option v-for="b in filteredBreeds" :value="b.id" :key="b.id">
                            {{ b.itemLabel }}
                        </option>
                    </select>

                    <footer>
                        <button type="button" class="secondary" @click="closeAllModals">å–æ¶ˆ</button>
                        <button type="submit" :aria-busy="loading.form">ä¿å­˜</button>
                    </footer>
                </form>
            </article>
        </dialog>

        <dialog :open="modals.weightForm.show" @click.self="closeAllModals">
            <article>
                <header>
                    <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                    <strong>æ·»åŠ ä½“é‡è®°å½•</strong>
                </header>
                <form @submit.prevent="handleSubmitWeightForm">
                    <label for="weightKg">ä½“é‡ (kg)</label>
                    <input type="number" step="0.01" id="weightKg" v-model="modals.weightForm.data.weightKg" required>

                    <label for="weightDate">è®°å½•æ—¥æœŸ</label>
                    <input type="date" id="weightDate" v-model="modals.weightForm.data.logDate" required>

                    <label for="weightNotes">å¤‡æ³¨</label>
                    <input type="text" id="weightNotes" v-model="modals.weightForm.data.notes" placeholder="å¯é€‰">

                    <footer>
                        <button type="button" class="secondary" @click="closeAllModals">å–æ¶ˆ</button>
                        <button type="submit" :aria-busy="loading.form">ä¿å­˜</button>
                    </footer>
                </form>
            </article>
        </dialog>

        <dialog :open="modals.healthEventForm.show" @click.self="closeAllModals">
            <article>
                <header>
                    <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                    <strong>æ·»åŠ å¥åº·äº‹ä»¶</strong>
                </header>
                <form @submit.prevent="handleSubmitHealthEventForm">
                    <label for="eventType">äº‹ä»¶ç±»å‹</label>
                    <select id="eventType" v-model="modals.healthEventForm.data.eventTypeId" required>
                        <option disabled value="">è¯·é€‰æ‹©äº‹ä»¶</option>
                        <option v-for="e in dictionaries.healthEvents" :value="e.id" :key="e.id">
                            {{ e.itemLabel }}
                        </option>
                    </select>

                    <label for="eventDate">äº‹ä»¶æ—¥æœŸ</label>
                    <input type="date" id="eventDate" v-model="modals.healthEventForm.data.eventDate" required>

                    <label for="eventNextDate">ä¸‹æ¬¡æ—¥æœŸ (å¯é€‰)</label>
                    <input type="date" id="eventNextDate" v-model="modals.healthEventForm.data.nextDueDate">

                    <label for="eventNotes">å¤‡æ³¨</label>
                    <input type="text" id="eventNotes" v-model="modals.healthEventForm.data.notes" placeholder="ä¾‹å¦‚: ç–«è‹—å“ç‰Œ, åŒ»é™¢">

                    <footer>
                        <button type="button" class="secondary" @click="closeAllModals">å–æ¶ˆ</button>
                        <button type="submit" :aria-busy="loading.form">ä¿å­˜</button>
                    </footer>
                </form>
            </article>
        </dialog>

    </main>
</div> <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    // ä» Vue ä¸­è§£æ„å‡ºæˆ‘ä»¬éœ€è¦çš„åŠŸèƒ½
    const { createApp, ref, onMounted, computed } = Vue;

    // é»˜è®¤è¡¨å•æ•°æ® (ç”¨äºé‡ç½®)
    const defaultPetForm = () => ({ name: '', birthday: '', speciesId: null, breedId: null });
    const defaultWeightForm = () => ({
        weightKg: null,
        logDate: new Date().toISOString().split('T')[0], // é»˜è®¤ä¸ºä»Šå¤©
        notes: ''
    });
    const defaultHealthForm = () => ({
        eventTypeId: null,
        eventDate: new Date().toISOString().split('T')[0], // é»˜è®¤ä¸ºä»Šå¤©
        nextDueDate: null,
        notes: ''
    });

    // åˆ›å»º Vue åº”ç”¨
    createApp({
        setup() {
            // --- ä½ çš„åç«¯ API åœ°å€ ---
            // â—â—â— ç¡®ä¿ä½ å·²ç»åœ¨ Spring Boot ä¸Šè®¾ç½®äº† @CrossOrigin("*") â—â—â—
            const API_BASE_URL = 'https://pets-why3.onrender.com';

            // --- 1. å“åº”å¼çŠ¶æ€ (State) ---

            const upcomingEvents = ref([]);
            const petList = ref([]);
            const pagination = ref({ current: 1, size: 10, total: 0 });

            // æ‰€æœ‰å­—å…¸
            const dictionaries = ref({
                species: [],
                breeds: [],
                healthEvents: []
            });

            // åŠ è½½çŠ¶æ€
            const loading = ref({
                list: false,
                detail: false,
                upcoming: false,
                form: false // ç”¨äºæ‰€æœ‰è¡¨å•çš„é€šç”¨åŠ è½½
            });

            // æ¨¡æ€æ¡†çŠ¶æ€
            const modals = ref({
                detail: { show: false, data: null, petId: null },
                petForm: { show: false, isEdit: false, data: defaultPetForm() },
                weightForm: { show: false, data: defaultWeightForm() },
                healthEventForm: { show: false, data: defaultHealthForm() }
            });

            // --- 2. è®¡ç®—å±æ€§ (Computed) ---

            // åŠ¨æ€è¿‡æ»¤å“ç§: ä»…æ˜¾ç¤ºæ‰€é€‰ç‰©ç§çš„å“ç§
            const filteredBreeds = computed(() => {
                const speciesId = modals.value.petForm.data.speciesId;
                if (!speciesId) {
                    return [];
                }
                return dictionaries.value.breeds.filter(b => b.parentId === speciesId);
            });

            // --- 3. æ–¹æ³• (Methods) ---

            // --- æ•°æ®è·å– ---
            const fetchPetList = () => {
                loading.value.list = true;
                axios.get(`${API_BASE_URL}/pets/page`, {
                    params: { pageNum: pagination.value.current, pageSize: pagination.value.size }
                })
                    .then(res => {
                        petList.value = res.data.records;
                        pagination.value.total = res.data.total;
                    })
                    .catch(err => alert('è·å–å® ç‰©åˆ—è¡¨å¤±è´¥: ' + err.message))
                    .finally(() => loading.value.list = false);
            };

            const fetchUpcomingEvents = () => {
                loading.value.upcoming = true;
                axios.get(`${API_BASE_URL}/health-events/upcoming`)
                    .then(res => upcomingEvents.value = res.data)
                    .catch(err => console.error('è·å–æé†’å¤±è´¥:', err))
                    .finally(() => loading.value.upcoming = false);
            };

            const fetchDictionaries = async () => {
                try {
                    // ä½¿ç”¨ Promise.all å¹¶è¡ŒåŠ è½½æ‰€æœ‰å­—å…¸
                    const [speciesRes, breedsRes, eventsRes] = await Promise.all([
                        axios.get(`${API_BASE_URL}/dictItems/code/PET_SPECIES`),
                        axios.get(`${API_BASE_URL}/dictItems/code/PET_BREED`),
                        axios.get(`${API_BASE_URL}/dictItems/code/HEALTH_EVENT_TYPE`)
                    ]);
                    dictionaries.value.species = speciesRes.data;
                    dictionaries.value.breeds = breedsRes.data;
                    dictionaries.value.healthEvents = eventsRes.data;
                } catch (err) {
                    alert('åŠ è½½åŸºç¡€æ•°æ®å¤±è´¥ï¼è¯·åˆ·æ–°é¡µé¢ã€‚' + err.message);
                }
            };

            const fetchPetDetail = (petId) => {
                loading.value.detail = true;
                axios.get(`${API_BASE_URL}/pets/detail/${petId}`)
                    .then(res => modals.value.detail.data = res.data)
                    .catch(err => {
                        alert('è·å–å® ç‰©è¯¦æƒ…å¤±è´¥: ' + err.message);
                        modals.value.detail.show = false;
                    })
                    .finally(() => loading.value.detail = false);
            };

            // --- æ¨¡æ€æ¡†æ§åˆ¶ ---
            const closeAllModals = () => {
                modals.value.detail.show = false;
                modals.value.petForm.show = false;
                modals.value.weightForm.show = false;
                modals.value.healthEventForm.show = false;
            };

            const handleShowDetail = (petId) => {
                closeAllModals();
                modals.value.detail.petId = petId; // å­˜å‚¨å½“å‰ petId
                modals.value.detail.data = null; // æ¸…ç©ºæ—§æ•°æ®
                modals.value.detail.show = true;
                fetchPetDetail(petId);
            };

            const handleCreatePet = () => {
                closeAllModals();
                modals.value.petForm.data = defaultPetForm();
                modals.value.petForm.isEdit = false;
                modals.value.petForm.show = true;
            };

            const handleEditPet = (pet) => {
                closeAllModals();
                // å¤åˆ¶æ•°æ®åˆ°è¡¨å•
                modals.value.petForm.data = {
                    id: pet.id,
                    name: pet.name,
                    birthday: pet.birthday,
                    speciesId: pet.speciesId,
                    breedId: pet.breedId
                };
                modals.value.petForm.isEdit = true;
                modals.value.petForm.show = true;
            };

            const handleShowWeightForm = () => {
                // petId å·²ç»å­˜åœ¨äº detail modal ä¸­
                modals.value.weightForm.data = defaultWeightForm();
                modals.value.weightForm.show = true;
            };

            const handleShowHealthEventForm = () => {
                modals.value.healthEventForm.data = defaultHealthForm();
                modals.value.healthEventForm.show = true;
            };

            // --- è¡¨å•æäº¤ (CRUD) ---
            const handleSubmitPetForm = () => {
                loading.value.form = true;
                const { isEdit, data } = modals.value.petForm;
                const request = isEdit
                    ? axios.put(`${API_BASE_URL}/pets/${data.id}`, data)
                    : axios.post(`${API_BASE_URL}/pets`, data);

                request.then(() => {
                    closeAllModals();
                    fetchPetList(); // åˆ·æ–°åˆ—è¡¨
                })
                    .catch(err => alert('ä¿å­˜å® ç‰©å¤±è´¥: ' + err.message))
                    .finally(() => loading.value.form = false);
            };

            const handleDeletePet = (petId, petName) => {
                if (!confirm(`ç¡®å®šè¦åˆ é™¤ [${petName}] å—ï¼Ÿè¿™ä¸ªæ“ä½œä¸å¯é€†ã€‚`)) {
                    return;
                }
                axios.delete(`${API_BASE_URL}/pets/${petId}`)
                    .then(() => {
                        fetchPetList(); // åˆ·æ–°åˆ—è¡¨
                    })
                    .catch(err => alert('åˆ é™¤å® ç‰©å¤±è´¥: ' + err.message));
            };

            const handleSubmitWeightForm = () => {
                loading.value.form = true;
                const payload = {
                    ...modals.value.weightForm.data,
                    petId: modals.value.detail.petId // é™„åŠ ä¸Š petId
                };

                axios.post(`${API_BASE_URL}/weight-logs`, payload)
                    .then(() => {
                        modals.value.weightForm.show = false; // åªå…³é—­å°æ¨¡æ€æ¡†
                        fetchPetDetail(modals.value.detail.petId); // åˆ·æ–°è¯¦æƒ…
                    })
                    .catch(err => alert('ä¿å­˜ä½“é‡å¤±è´¥: ' + err.message))
                    .finally(() => loading.value.form = false);
            };

            const handleSubmitHealthEventForm = () => {
                loading.value.form = true;
                const payload = {
                    ...modals.value.healthEventForm.data,
                    petId: modals.value.detail.petId // é™„åŠ ä¸Š petId
                };

                axios.post(`${API_BASE_URL}/health-events`, payload)
                    .then(() => {
                        modals.value.healthEventForm.show = false; // åªå…³é—­å°æ¨¡æ€æ¡†
                        fetchPetDetail(modals.value.detail.petId); // åˆ·æ–°è¯¦æƒ…
                        fetchUpcomingEvents(); // åˆ·æ–°é¦–é¡µæé†’
                    })
                    .catch(err => alert('ä¿å­˜äº‹ä»¶å¤±è´¥: ' + err.message))
                    .finally(() => loading.value.form = false);
            };

            // --- 4. ç”Ÿå‘½å‘¨æœŸ (Lifecycle) ---

            // é¡µé¢åŠ è½½æ—¶, è‡ªåŠ¨è¿è¡Œ
            onMounted(async () => {
                // å¹¶è¡Œè·å–åˆå§‹æ•°æ®
                await fetchDictionaries(); // å¿…é¡»å…ˆåŠ è½½å­—å…¸
                fetchPetList();
                fetchUpcomingEvents();
            });

            // --- 5. è¿”å› (Return) ---
            return {
                // çŠ¶æ€
                upcomingEvents,
                petList,
                dictionaries,
                loading,
                modals,
                // è®¡ç®—å±æ€§
                filteredBreeds,
                // æ–¹æ³•
                handleShowDetail,
                handleCreatePet,
                handleEditPet,
                handleDeletePet,
                handleSubmitPetForm,
                handleShowWeightForm,
                handleSubmitWeightForm,
                handleShowHealthEventForm,
                handleSubmitHealthEventForm,
                closeAllModals,
            };
        }
    }).mount('#app'); // æŒ‚è½½åˆ° <div id="app">
</script>

</body>
</html>