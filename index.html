<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <title>å® ç‰©ç®¡å®¶</title>
</head>
<body>

<div id="app" class="container" @click.self="closeAllModals">

    <article v-if="setupError" style="border-color: var(--pico-form-invalid-color);">
        <header><h5 style="color: var(--pico-form-invalid-color);">[å‰ç«¯è‡´å‘½é”™è¯¯] åº”ç”¨åŠ è½½å¤±è´¥</h5></header>
        <p>æŠ±æ­‰, JavaScript é€»è¾‘åœ¨åˆå§‹åŒ–æ—¶å´©æºƒäº†ã€‚è¯·æ£€æŸ¥æ§åˆ¶å° (F12)ã€‚</p>
        <pre><code>{{ setupError }}</code></pre>
    </article>

    <div v-else>
        <header>
            <nav>
                <ul><li><strong>ğŸ¾ å® ç‰©ç®¡å®¶</strong></li></ul>
                <ul>
                    <li>
                        <a href="#" :class="{ 'secondary': currentPage !== 'pets' }" @click.prevent="currentPage = 'pets'">
                            å® ç‰©ç®¡ç†
                        </a>
                    </li>
                    <li>
                        <a href="#" :class="{ 'secondary': currentPage !== 'dictionaries' }" @click.prevent="showDictionaryPage">
                            å­—å…¸ç®¡ç†
                        </a>
                    </li>
                </ul>
            </nav>
        </header>

        <hr>

        <main v-if="currentPage === 'pets'">
            <article :aria-busy="loading.upcoming">
                <header><h5>ğŸ”” å³å°†åˆ°æœŸçš„äº‹ä»¶ (7å¤©å†…)</h5></header>
                <ul v-if="upcomingEvents.length">
                    <li v-for="event in upcomingEvents" :key="event.id">
                        <strong>{{ event.nextDueDate }}</strong> - å® ç‰©ID {{ event.petId }} éœ€è¦: {{ event.notes || 'æ‰§è¡Œäº‹ä»¶' }}
                    </li>
                </ul>
                <p v-else><i>å¤ªå¥½äº†, 7å¤©å†…æ²¡æœ‰éœ€è¦æé†’çš„äº‹ä»¶ã€‚</i></p>
            </article>
            <br>
            <article :aria-busy="loading.list">
                <header>
                    <h3>å® ç‰©åˆ—è¡¨</h3>
                    <button @click="handleCreatePet">æ·»åŠ æ–°å® ç‰©</button>
                </header>
                <table>
                    <thead>
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">åå­—</th>
                        <th scope="col">æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="pet in petList" :key="pet.id">
                        <td>{{ pet.id }}</td>
                        <td><strong>{{ pet.name }}</strong></td>
                        <td>
                            <div class="grid" style="--pico-grid-spacing: 0.5rem;">
                                <button @click="handleShowDetail(pet.id)">æŸ¥çœ‹</button>
                                <button class="secondary" @click="handleEditPet(pet)">ç¼–è¾‘</button>
                                <button class="outline secondary" @click="handleDeletePet(pet.id, pet.name)">åˆ é™¤</button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </article>
        </main>

        <main v-if="currentPage === 'dictionaries'">
            <div class="grid">
                <article :aria-busy="loading.dictTypes">
                    <header>
                        <strong>å­—å…¸ç±»å‹ (åªè¯»)</strong>
                    </header>
                    <ul style="padding-left: 0; list-style: none;">
                        <li v-for="type in dictTypeTree" :key="type.dictCode">
                            <details :open="type.children.length > 0">
                                <summary>
                                    <a href="#"
                                       :style="{ color: type.dictCode === selectedDictCode ? 'var(--pico-primary)' : 'inherit' }"
                                       @click.prevent="selectDictType(type)">
                                        {{ type.dictName }} (<code>{{ type.dictCode }}</code>)
                                    </a>
                                </summary>
                                <ul style="padding-left: 1rem; margin-top: 0.5rem;">
                                    <li v-for="child in type.children" :key="child.dictCode">
                                        <a href="#"
                                           :style="{ color: child.dictCode === selectedDictCode ? 'var(--pico-primary)' : 'inherit' }"
                                           @click.prevent="selectDictType(child)">
                                            {{ child.dictName }} (<code>{{ child.dictCode }}</code>)
                                        </a>
                                    </li>
                                </ul>
                            </details>
                        </li>
                    </ul>
                </article>

                <article :aria-busy="loading.dictItems">
                    <header v-if="!selectedDictCode">
                        <strong>å­—å…¸é¡¹</strong><br>
                        <small>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå­—å…¸ç±»å‹</small>
                    </header>
                    <header v-else>
                        <strong>å­—å…¸é¡¹ (<code>{{ selectedDictCode }}</code>)</strong>
                        <button class="outline" @click="handleCreateDictItem" style="padding: 0.25rem 0.5rem; margin-left: 1rem;">+</button>
                    </header>
                    <table v-if="selectedDictCode">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>æ ‡ç­¾ (Label)</th>
                            <th>å€¼ (Value)</th>
                            <th>çˆ¶ID</th>
                            <th>æ“ä½œ</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="item in dictItemList" :key="item.id">
                            <td>{{ item.id }}</td>
                            <td><strong>{{ item.itemLabel }}</strong></td>
                            <td><code>{{ item.itemValue }}</code></td>
                            <td>{{ item.parentId || 'N/A' }}</td>
                            <td>
                                <div class="grid" style="--pico-grid-spacing: 0.5rem;">
                                    <button class="secondary" @click="handleEditDictItem(item)" style="padding: 0.25rem 0.5rem;">ç¼–è¾‘</button>
                                    <button class="outline contrast" @click="handleDeleteDictItem(item)" style="padding: 0.25rem 0.5rem;">åˆ é™¤</button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </article>
            </div> </main>

        <dialog :open="modals.detail.show" @click.self="closeAllModals">
            <article :aria-busy="loading.detail">
                <header>
                    <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                    <strong>{{ modals.detail.data ? modals.detail.data.name : 'åŠ è½½ä¸­...' }}</strong>
                </header>
                <div v-if="modals.detail.data">
                    <ul>
                        <li><strong>ç‰©ç§:</strong> {{ modals.detail.data.speciesLabel }}</li>
                        <li><strong>å“ç§:</strong> {{ modals.detail.data.breedLabel }}</li>
                    </ul>
                    <hr>
                    <h4>è¿‘æœŸä½“é‡</h4>
                    <ul v-if="modals.detail.data.weightLogs && modals.detail.data.weightLogs.length">
                        <li v-for="log in modals.detail.data.weightLogs" :key="log.id">
                            {{ log.logDate }}: {{ log.weightKg }} kg
                        </li>
                    </ul>
                    <p v-else><i>æš‚æ— ä½“é‡è®°å½•</i></p>
                    <hr>
                    <h4>å¥åº·äº‹ä»¶</h4>
                    <ul v-if="modals.detail.data.healthEvents && modals.detail.data.healthEvents.length">
                        <li v-for="event in modals.detail.data.healthEvents" :key="event.id">
                            {{ event.eventDate }}: {{ event.notes || 'æ‰§è¡Œäº†äº‹ä»¶' }} (ä¸‹æ¬¡: {{ event.nextDueDate || 'N/A' }})
                        </li>
                    </ul>
                    <p v-else><i>æš‚æ— å¥åº·äº‹ä»¶</i></p>
                </div>
                <footer class="grid">
                    <button class="outline" @click="handleShowWeightForm">æ·»åŠ ä½“é‡</button>
                    <button class="outline" @click="handleShowHealthEventForm">æ·»åŠ äº‹ä»¶</button>
                    <button class="secondary" @click="closeAllModals">å…³é—­</button>
                </footer>
            </article>
        </dialog>

        <dialog :open="modals.petForm.show" @click.self="closeAllModals">
            <article :aria-busy="loading.form">
                <header>
                    <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                    <strong>{{ modals.petForm.isEdit ? 'ç¼–è¾‘å® ç‰©' : 'åˆ›å»ºæ–°å® ç‰©' }}</strong>
                </header>
                <form @submit.prevent="handleSubmitPetForm">
                    <label for="petName">åå­—</label>
                    <input type="text" id="petName" v-model="modals.petForm.data.name" required>
                    <label for="petBday">ç”Ÿæ—¥</label>
                    <input type="date" id="petBday" v-model="modals.petForm.data.birthday">
                    <label for="petSpecies">ç‰©ç§</label>
                    <select id="petSpecies" v-model="modals.petForm.data.speciesId" required>
                        <option disabled value="">è¯·é€‰æ‹©ç‰©ç§</option>
                        <option v-for="s in dictionaries.species" :value="s.id" :key="s.id">{{ s.itemLabel }}</option>
                    </select>
                    <label for="petBreed">å“ç§</label>
                    <select id="petBreed" v-model="modals.petForm.data.breedId">
                        <option value="">è¯·é€‰æ‹©å“ç§ (å¯é€‰)</option>
                        <option v-for="b in filteredBreeds" :value="b.id" :key="b.id">{{ b.itemLabel }}</option>
                    </select>
                    <footer>
                        <button type="button" class="secondary" @click="closeAllModals">å–æ¶ˆ</button>
                        <button type="submit" :aria-busy="loading.form">ä¿å­˜</button>
                    </footer>
                </form>
            </article>
        </dialog>

        <dialog :open="modals.weightForm.show" @click.self="closeAllModals">
            <article>
                <header>
                    <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                    <strong>æ·»åŠ ä½“é‡è®°å½•</strong>
                </header>
                <form @submit.prevent="handleSubmitWeightForm">
                    <label for="weightKg">ä½“é‡ (kg)</label>
                    <input type="number" step="0.01" id="weightKg" v-model="modals.weightForm.data.weightKg" required>
                    <label for="weightDate">è®°å½•æ—¥æœŸ</label>
                    <input type="date" id="weightDate" v-model="modals.weightForm.data.logDate" required>
                    <label for="weightNotes">å¤‡æ³¨</label>
                    <input type="text" id="weightNotes" v-model="modals.weightForm.data.notes" placeholder="å¯é€‰">
                    <footer>
                        <button type="button" class="secondary" @click="closeAllModals">å–æ¶ˆ</button>
                        <button type="submit" :aria-busy="loading.form">ä¿å­˜</button>
                    </footer>
                </form>
            </article>
        </dialog>

        <dialog :open="modals.healthEventForm.show" @click.self="closeAllModals">
            <article>
                <header>
                    <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                    <strong>æ·»åŠ å¥åº·äº‹ä»¶</strong>
                </header>
                <form @submit.prevent="handleSubmitHealthEventForm">
                    <label for="eventType">äº‹ä»¶ç±»å‹</label>
                    <select id="eventType" v-model="modals.healthEventForm.data.eventTypeId" required>
                        <option disabled value="">è¯·é€‰æ‹©äº‹ä»¶</option>
                        <option v-for="e in dictionaries.healthEvents" :value="e.id" :key="e.id">{{ e.itemLabel }}</option>
                    </select>
                    <label for="eventDate">äº‹ä»¶æ—¥æœŸ</label>
                    <input type="date" id="eventDate" v-model="modals.healthEventForm.data.eventDate" required>
                    <label for="eventNextDate">ä¸‹æ¬¡æ—¥æœŸ (å¯é€‰)</label>
                    <input type="date" id="eventNextDate" v-model="modals.healthEventForm.data.nextDueDate">
                    <label for="eventNotes">å¤‡æ³¨</label>
                    <input type="text" id="eventNotes" v-model="modals.healthEventForm.data.notes" placeholder="ä¾‹å¦‚: ç–«è‹—å“ç‰Œ, åŒ»é™¢">
                    <footer>
                        <button type="button" class="secondary" @click="closeAllModals">å–æ¶ˆ</button>
                        <button type="submit" :aria-busy="loading.form">ä¿å­˜</button>
                    </footer>
                </form>
            </article>
        </dialog>

        <dialog :open="modals.dictItemForm.show" @click.self="closeAllModals">
            <article :aria-busy="loading.form || loading.dictParentOptions"> <header>
                <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                <strong>{{ modals.dictItemForm.isEdit ? 'ç¼–è¾‘å­—å…¸é¡¹' : 'åˆ›å»ºæ–°å­—å…¸é¡¹' }}</strong>
            </header>
                <form @submit.prevent="handleSubmitDictItemForm">
                    <label for="dictCode">å­—å…¸ç¼–ç  (Code)</label>
                    <input type="text" id="dictCode" v-model="modals.dictItemForm.data.dictCode" required readonly disabled>

                    <label for="dictLabel">æ ‡ç­¾ (Label)</label>
                    <input type="text" id="dictLabel" v-model="modals.dictItemForm.data.itemLabel" required>

                    <label for="dictValue">å€¼ (Value)</label>
                    <input type="text" id="dictValue" v-model="modals.dictItemForm.data.itemValue" required>

                    <label for="dictParent">çˆ¶çº§ID (å¯é€‰)</label>
                    <select id="dictParent"
                            v-model="modals.dictItemForm.data.parentId"
                            :aria-busy="loading.dictParentOptions"
                            :disabled="loading.dictParentOptions || dictParentOptions.length === 0">

                        <option :value="null">(æ— çˆ¶çº§/ä¸å…³è”)</option>

                        <option v-for="opt in dictParentOptions" :value="opt.id" :key="opt.id">
                            {{ opt.label }} (ID: {{ opt.id }})
                        </option>
                    </select>

                    <label for="dictSort">æ’åº</label>
                    <input type="number" id="dictSort" v-model="modals.dictItemForm.data.sortOrder">

                    <footer>
                        <button type="button" class="secondary" @click="closeAllModals">å–æ¶ˆ</button>
                        <button type="submit" :aria-busy="loading.form">ä¿å­˜</button>
                    </footer>
                </form>
            </article>
        </dialog>
        <dialog :open="modals.auth.show" @click.self="closeAllModals">
            <article style="max-width: 400px;">
                <header>
                    <a href="#" aria-label="Close" class="close" @click.prevent="closeAllModals"></a>
                    <strong>èº«ä»½è®¤è¯</strong>
                </header>
                <form @submit.prevent="login">
                    <label for="authPassword">è¯·è¾“å…¥å­—å…¸ç®¡ç†å¯†ç </label>
                    <input type="password" id="authPassword" v-model="auth.password" autofocus>
                    <button type="submit" :aria-busy="auth.loading">æäº¤</button>
                    <small v-if="auth.error" style="color: var(--pico-form-invalid-color);">{{ auth.error }}</small>
                </form>
            </article>
        </dialog>

    </div> </div> <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    // ä» Vue ä¸­è§£æ„å‡ºæˆ‘ä»¬éœ€è¦çš„åŠŸèƒ½
    const { createApp, ref, onMounted, computed, watch } = Vue;

    // --- é»˜è®¤è¡¨å•æ•°æ® ---
    const defaultPetForm = () => ({ name: '', birthday: '', speciesId: null, breedId: null });
    const defaultWeightForm = () => ({ petId: null, weightKg: null, logDate: new Date().toISOString().split('T')[0], notes: '' });
    const defaultHealthForm = () => ({ petId: null, eventTypeId: null, eventDate: new Date().toISOString().split('T')[0], nextDueDate: null, notes: '' });
    // (â—) ç¡®è®¤ parentId: null, åŒ¹é… <option :value="null">
    const defaultDictItemForm = () => ({ dictCode: '', itemValue: '', itemLabel: '', parentId: null, sortOrder: 0 });

    // é”™è¯¯æ•è·
    const setupError = ref(null);

    createApp({
        setup() {
            try {
                // --- (â—) å…¨è‡ªåŠ¨ç¯å¢ƒé…ç½® (ä¿æŒä¸å˜) ---
                const hostname = window.location.hostname;
                const isLocal = (hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '0.0.0.0' || hostname === '');
                let API_BASE_URL;
                if (isLocal) {
                    API_BASE_URL = 'http://localhost:8080';
                } else {
                    API_BASE_URL = 'https://pets-why3.onrender.com';
                }
                console.log(`[Config] å½“å‰ç¯å¢ƒ: ${isLocal ? 'æœ¬åœ°' : 'ç”Ÿäº§'}, API URL: ${API_BASE_URL}`);
                // --------------------------------------------------------

                // --- 1. å“åº”å¼çŠ¶æ€ (State) ---
                const auth = ref({ isAuthenticated: false, password: '', error: '', loading: false });
                const currentPage = ref('pets');
                const upcomingEvents = ref([]);
                const petList = ref([]);
                const pagination = ref({ current: 1, size: 10, total: 0 });
                const dictionaries = ref({ species: [], breeds: [], healthEvents: [] });
                const dictTypeList = ref([]);

                // (â— å…³é”®ä¿®æ”¹)
                const selectedDictCode = ref(null);
                const selectedDictType = ref(null); // (â— æ–°å¢) å­˜å‚¨å®Œæ•´çš„å­—å…¸ç±»å‹å¯¹è±¡
                const dictItemList = ref([]);
                const dictParentOptions = ref([]); // (â— æ–°å¢) å­˜å‚¨çˆ¶çº§IDä¸‹æ‹‰æ¡†é€‰é¡¹

                // (â— å…³é”®ä¿®æ”¹)
                const loading = ref({
                    list: false, detail: false, upcoming: false, form: false,
                    dictTypes: false,
                    dictItems: false,
                    dictParentOptions: false // (â— æ–°å¢) çˆ¶çº§é€‰é¡¹çš„åŠ è½½çŠ¶æ€
                });

                const modals = ref({
                    detail: { show: false, data: null, petId: null },
                    petForm: { show: false, isEdit: false, data: defaultPetForm() },
                    weightForm: { show: false, data: defaultWeightForm() },
                    healthEventForm: { show: false, data: defaultHealthForm() },
                    dictItemForm: { show: false, isEdit: false, data: defaultDictItemForm() },
                    auth: { show: false }
                });

                // --- 2. è®¡ç®—å±æ€§ (Computed) ---
                const filteredBreeds = computed(() => {
                    const speciesId = modals.value.petForm.data.speciesId;
                    if (!speciesId) return [];
                    return dictionaries.value.breeds.filter(b => b.parentId === speciesId);
                });

                const dictTypeTree = computed(() => {
                    const types = dictTypeList.value;
                    const parents = types.filter(t => !t.parentCode);
                    const children = types.filter(t => t.parentCode);
                    return parents.map(p => ({
                        ...p,
                        children: children.filter(c => c.parentCode === p.dictCode)
                    }));
                });

                // --- 3. æ–¹æ³• (Methods) ---

                // (çœç•¥) è®¤è¯...
                const login = () => {
                    auth.value.loading = true; auth.value.error = '';
                    setTimeout(() => {
                        if (auth.value.password === '123456') {
                            auth.value.isAuthenticated = true; modals.value.auth.show = false; currentPage.value = 'dictionaries';
                        } else {
                            auth.value.error = 'å¯†ç é”™è¯¯';
                        }
                        auth.value.loading = false; auth.value.password = '';
                    }, 300);
                };
                const showDictionaryPage = () => {
                    if (auth.value.isAuthenticated) {
                        currentPage.value = 'dictionaries';
                    } else {
                        auth.value.error = ''; auth.value.password = ''; modals.value.auth.show = true;
                    }
                };

                // --- æ•°æ®è·å– (Fetchers) ---

                // (çœç•¥) å® ç‰©ç›¸å…³çš„ fetchers...
                const fetchPetList = () => {
                    loading.value.list = true;
                    axios.get(`${API_BASE_URL}/pets/page`, { params: { pageNum: pagination.value.current, pageSize: pagination.value.size } })
                        .then(res => { petList.value = res.data.records; pagination.value.total = res.data.total; })
                        .catch(err => alert('è·å–å® ç‰©åˆ—è¡¨å¤±è´¥: ' + err.message))
                        .finally(() => loading.value.list = false);
                };
                const fetchUpcomingEvents = () => {
                    loading.value.upcoming = true;
                    axios.get(`${API_BASE_URL}/health-events/upcoming`)
                        .then(res => upcomingEvents.value = res.data)
                        .catch(err => console.error('è·å–æé†’å¤±è´¥:', err))
                        .finally(() => loading.value.upcoming = false);
                };
                const fetchDictionaries = async () => {
                    try {
                        const [speciesRes, breedsRes, eventsRes] = await Promise.all([
                            axios.get(`${API_BASE_URL}/dictItems/code/PET_SPECIES`),
                            axios.get(`${API_BASE_URL}/dictItems/code/PET_BREED`),
                            axios.get(`${API_BASE_URL}/dictItems/code/HEALTH_EVENT_TYPE`)
                        ]);
                        dictionaries.value.species = speciesRes.data;
                        dictionaries.value.breeds = breedsRes.data;
                        dictionaries.value.healthEvents = eventsRes.data;
                    } catch (err) {
                        alert('åŠ è½½åŸºç¡€æ•°æ®å¤±è´¥ï¼è¯·åˆ·æ–°é¡µé¢ã€‚' + err.message);
                    }
                };
                const fetchPetDetail = (petId) => {
                    loading.value.detail = true;
                    axios.get(`${API_BASE_URL}/pets/detail/${petId}`)
                        .then(res => modals.value.detail.data = res.data)
                        .catch(err => { alert('è·å–å® ç‰©è¯¦æƒ…å¤±è´¥: ' + err.message); modals.value.detail.show = false; })
                        .finally(() => loading.value.detail = false);
                };

                // (çœç•¥) å­—å…¸ç±»å‹/é¡¹ åˆ—è¡¨çš„ fetchers...
                const fetchDictTypeList = () => {
                    loading.value.dictTypes = true;
                    axios.get(`${API_BASE_URL}/dictTypes`)
                        .then(res => {
                            dictTypeList.value = res.data;
                        })
                        .catch(err => alert('è·å–å­—å…¸ç±»å‹åˆ—è¡¨å¤±è´¥: ' + err.message))
                        .finally(() => loading.value.dictTypes = false);
                };
                const fetchDictItemList = (dictCode) => {
                    if (!dictCode) {
                        dictItemList.value = [];
                        return;
                    }
                    loading.value.dictItems = true;
                    axios.get(`${API_BASE_URL}/dictItems/code/${dictCode}`)
                        .then(res => {
                            dictItemList.value = res.data;
                        })
                        .catch(err => alert(`è·å–å­—å…¸é¡¹ [${dictCode}] å¤±è´¥: ` + err.message))
                        .finally(() => loading.value.dictItems = false);
                };

                // (â—â—â— æ–°å¢) è·å–å­—å…¸é¡¹çš„çˆ¶çº§ä¸‹æ‹‰æ¡†é€‰é¡¹
                const fetchDictParentOptions = async (parentDictCode) => {
                    loading.value.dictParentOptions = true;
                    dictParentOptions.value = []; // å…ˆæ¸…ç©º

                    // (â—) æ ¡éªŒ: å¦‚æœ parentCode ä¸º null (æ ¹ç±»å‹), ç›´æ¥è¿”å›ç©ºåˆ—è¡¨
                    // å¯¹åº”åç«¯çš„ (StringUtils.isBlank(dictCode))
                    if (!parentDictCode) {
                        loading.value.dictParentOptions = false;
                        return; // (e.g., ç‰©ç§ PET_SPECIES, å®ƒæ²¡æœ‰çˆ¶çº§)
                    }

                    try {
                        // (â—) è°ƒç”¨æˆ‘ä»¬æ–°è®¾è®¡çš„ /lookup æ¥å£
                        const res = await axios.get(`${API_BASE_URL}/dictItems/lookup`, {
                            params: { dictCode: parentDictCode } // (e.g., PET_SPECIES)
                        });
                        dictParentOptions.value = res.data;
                    } catch (err) {
                        console.error('åŠ è½½çˆ¶çº§é€‰é¡¹å¤±è´¥:', err);
                        // ä¸å¼¹çª—, ä»…åœ¨æ§åˆ¶å°æŠ¥é”™, ä¸‹æ‹‰æ¡†ä¼šæ˜¾ç¤ºä¸ºç©º
                    } finally {
                        loading.value.dictParentOptions = false;
                    }
                };


                // --- å­—å…¸ç®¡ç†é¡µäº¤äº’ ---

                // (â— å…³é”®ä¿®æ”¹)
                const selectDictType = (type) => {
                    selectedDictCode.value = type.dictCode;
                    selectedDictType.value = type; // (â— å…³é”®) å­˜å‚¨å®Œæ•´å¯¹è±¡
                    fetchDictItemList(type.dictCode);
                };

                // --- æ¨¡æ€æ¡†æ§åˆ¶ (Handlers) ---

                const closeAllModals = () => {
                    modals.value.detail.show = false;
                    modals.value.petForm.show = false;
                    modals.value.weightForm.show = false;
                    modals.value.healthEventForm.show = false;
                    modals.value.dictItemForm.show = false;
                    modals.value.auth.show = false;
                };

                // (çœç•¥) å® ç‰©ç›¸å…³çš„ Handlers...
                const handleShowDetail = (petId) => { closeAllModals(); modals.value.detail.petId = petId; modals.value.detail.data = null; modals.value.detail.show = true; fetchPetDetail(petId); };
                const handleCreatePet = () => { closeAllModals(); modals.value.petForm.data = defaultPetForm(); modals.value.petForm.isEdit = false; modals.value.petForm.show = true; };
                const handleEditPet = (pet) => { closeAllModals(); modals.value.petForm.data = { ...pet }; modals.value.petForm.isEdit = true; modals.value.petForm.show = true; };
                const handleShowWeightForm = () => {
                    const petId = modals.value.detail.petId;
                    modals.value.weightForm.data = { ...defaultWeightForm(), petId: petId };
                    modals.value.weightForm.show = true;
                };
                const handleShowHealthEventForm = () => {
                    const petId = modals.value.detail.petId;
                    modals.value.healthEventForm.data = { ...defaultHealthForm(), petId: petId };
                    modals.value.healthEventForm.show = true;
                };


                // (â— å…³é”®ä¿®æ”¹)
                const handleCreateDictItem = () => {
                    // (â—) ä½¿ç”¨ selectedDictType è€Œä¸æ˜¯ selectedDictCode
                    if (!selectedDictType.value) {
                        alert('è¯·å…ˆä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå­—å…¸ç±»å‹');
                        return;
                    }
                    closeAllModals();
                    modals.value.dictItemForm.data = {
                        ...defaultDictItemForm(),
                        dictCode: selectedDictType.value.dictCode // (e.g., "PET_BREED")
                    };
                    modals.value.dictItemForm.isEdit = false;
                    modals.value.dictItemForm.show = true;

                    // (â— å…³é”®) è§¦å‘çˆ¶çº§é€‰é¡¹åŠ è½½
                    // (e.g., ä¼ å…¥ "PET_SPECIES")
                    fetchDictParentOptions(selectedDictType.value.parentCode);
                };

                // (â— å…³é”®ä¿®æ”¹)
                const handleEditDictItem = (item) => {
                    closeAllModals();
                    modals.value.dictItemForm.data = { ...item };
                    modals.value.dictItemForm.isEdit = true;
                    modals.value.dictItemForm.show = true;

                    // (â— å…³é”®) è§¦å‘çˆ¶çº§é€‰é¡¹åŠ è½½
                    // (selectedDictType.value æ­¤æ—¶ä¸€å®šæ˜¯æ¿€æ´»çš„)
                    if (selectedDictType.value) {
                        fetchDictParentOptions(selectedDictType.value.parentCode);
                    }
                };

                // --- è¡¨å•æäº¤ (Submits / Deletes) ---

                // (çœç•¥) å® ç‰©, ä½“é‡, å¥åº·äº‹ä»¶çš„ Submits...
                const handleSubmitPetForm = () => {
                    loading.value.form = true;
                    const { isEdit, data } = modals.value.petForm;
                    const payload = { ...data };

                    const request = isEdit
                        ? axios.put(`${API_BASE_URL}/pets/${payload.id}`, payload)
                        : axios.post(`${API_BASE_URL}/pets`, payload);

                    request.then((res) => {
                        closeAllModals();
                        fetchPetList();
                        if (!isEdit) alert(res.data);
                    }).catch(err => alert('ä¿å­˜å® ç‰©å¤±è´¥: ' + (err.response?.data || err.message)))
                        .finally(() => loading.value.form = false);
                };
                const handleDeletePet = (petId, petName) => {
                    if (!confirm(`ç¡®å®šè¦åˆ é™¤ [${petName}] å—ï¼Ÿ`)) return;

                    axios.delete(`${API_BASE_URL}/pets/${petId}`)
                        .then(() => {
                            fetchPetList();
                        }).catch(err => alert('åˆ é™¤å® ç‰©å¤±è´¥: ' + (err.response?.data || err.message)));
                };
                const handleSubmitWeightForm = () => {
                    loading.value.form = true;
                    const payload = { ...modals.value.weightForm.data };

                    axios.post(`${API_BASE_URL}/weight-logs`, payload)
                        .then((res) => {
                            alert(res.data);
                            modals.value.weightForm.show = false;
                            fetchPetDetail(payload.petId);
                        }).catch(err => alert('ä¿å­˜ä½“é‡å¤±è´¥: ' + (err.response?.data || err.message)))
                        .finally(() => loading.value.form = false);
                };
                const handleSubmitHealthEventForm = () => {
                    loading.value.form = true;
                    const payload = { ...modals.value.healthEventForm.data };

                    axios.post(`${API_BASE_URL}/health-events`, payload)
                        .then((res) => {
                            alert(res.data);
                            modals.value.healthEventForm.show = false;
                            fetchPetDetail(payload.petId);
                            fetchUpcomingEvents();
                        }).catch(err => alert('ä¿å­˜äº‹ä»¶å¤±è´¥: ' + (err.response?.data || err.message)))
                        .finally(() => loading.value.form = false);
                };

                // (â— å­—å…¸é¡¹æäº¤: éªŒè¯ parentId é€»è¾‘)
                const handleSubmitDictItemForm = () => {
                    loading.value.form = true;
                    const { isEdit, data } = modals.value.dictItemForm;
                    // (â—) è¿™é‡Œçš„ || null é€»è¾‘æ˜¯å¥å£®çš„
                    // å®ƒå¯ä»¥å¤„ç† v-model ä¼ æ¥çš„ null (æ¥è‡ª :value="null")
                    const payload = { ...data, parentId: data.parentId || null };

                    const request = isEdit
                        ? axios.put(`${API_BASE_URL}/dictItems/${payload.id}`, payload)
                        : axios.post(`${API_BASE_URL}/dictItems`, payload);

                    request.then((res) => {
                        alert(res.data);
                        closeAllModals();
                        fetchDictItemList(selectedDictCode.value);
                        // (â—) é‡æ–°åŠ è½½å­—å…¸, ä¿è¯ PET_BREED ç­‰çš„æ›´æ–°
                        fetchDictionaries();
                    })
                        .catch(err => alert('ä¿å­˜å­—å…¸é¡¹å¤±è´¥: ' + (err.response?.data || err.message)))
                        .finally(() => loading.value.form = false);
                };

                const handleDeleteDictItem = (item) => {
                    if (!confirm(`ç¡®å®šè¦åˆ é™¤å­—å…¸é¡¹ [${item.itemLabel}] å—ï¼Ÿ`)) return;

                    axios.delete(`${API_BASE_URL}/dictItems/${item.id}`)
                        .then((res) => {
                            alert(res.data);
                            fetchDictItemList(selectedDictCode.value);
                            // (â—) é‡æ–°åŠ è½½å­—å…¸
                            fetchDictionaries();
                        })
                        .catch(err => alert('åˆ é™¤å­—å…¸é¡¹å¤±è´¥: ' + (err.response?.data || err.message)));
                };

                // --- 4. ç”Ÿå‘½å‘¨æœŸ (Lifecycle) ---

                onMounted(() => {
                    loading.value.upcoming = true;
                    loading.value.list = true;
                    fetchDictionaries().then(() => {
                        fetchPetList();
                        fetchUpcomingEvents();
                    });
                });

                watch(currentPage, (newPage) => {
                    if (newPage === 'dictionaries' && dictTypeList.value.length === 0) {
                        fetchDictTypeList();
                    }
                });

                // --- 5. è¿”å› (Return) ---
                return {
                    // é”™è¯¯
                    setupError,
                    // çŠ¶æ€
                    auth, login, currentPage, showDictionaryPage,
                    upcomingEvents, petList, loading, modals, filteredBreeds,
                    dictionaries,
                    dictTypeList, dictTypeTree, selectedDictCode, dictItemList,
                    selectedDictType, // (â— æ–°å¢)
                    dictParentOptions, // (â— æ–°å¢)
                    // æ–¹æ³•
                    selectDictType,
                    handleShowDetail, handleCreatePet, handleEditPet, handleDeletePet,
                    handleSubmitPetForm, handleShowWeightForm, handleSubmitWeightForm,
                    handleShowHealthEventForm, handleSubmitHealthEventForm, closeAllModals,
                    handleCreateDictItem, handleEditDictItem, handleDeleteDictItem, handleSubmitDictItemForm,
                };

            } catch (err) {
                console.error("Vue setup å¤±è´¥:", err);
                setupError.value = err;
                return {
                    setupError,
                    // è¿”å›ç©ºå€¼é˜²æ­¢ v-if="!setupError" å†…éƒ¨çš„ v-if å´©æºƒ
                    upcomingEvents: [], petList: [], dictTypeTree: [],
                    modals: { detail: {}, petForm: {}, weightForm: {}, healthEventForm: {}, dictItemForm: {}, auth: {} },
                    loading: {}, filteredBreeds: [],
                    dictParentOptions: [] // (â— æ–°å¢)
                };
            }
        }
    }).mount('#app');
</script>

</body>
</html>